__d(function(g,r,i,a,m,_e,d){"use strict";Object.defineProperty(_e,'__esModule',{value:!0}),Object.defineProperty(_e,"udpBroadcastService",{enumerable:!0,get:function(){return n}});var o,t=r(d[0]),s=(o=t)&&o.__esModule?o:{default:o},e=r(d[1]);const c=8888;const n=new class{socket=null;broadcastInterval=null;roomInfo=null;discoveredRooms=new Map;roomTimeouts=new Map;onRoomDiscoveredCallback=null;broadcastFailureCount=0;maxBroadcastFailures=5;isSocketHealthy=!0;timers=new Set;clearAllTimers(){console.log(`\ud83e\uddf9 [UDPBroadcast] \u6e05\u7406 ${this.timers.size} \u4e2a\u6d3b\u8dc3\u5b9a\u65f6\u5668`),this.timers.forEach(o=>{try{clearTimeout(o)}catch(o){console.warn('\u6e05\u7406\u5b9a\u65f6\u5668\u5931\u8d25:',o)}}),this.timers.clear()}startListening(o){if(this.socket)console.log('\u26a0\ufe0f UDP listener already running');else{this.onRoomDiscoveredCallback=o||null,console.log('\ud83c\udfa7 \u521b\u5efa UDP Socket \u7528\u4e8e\u76d1\u542c\u5e7f\u64ad...'),console.log("\ud83d\udccd \u76d1\u542c\u914d\u7f6e: \u7aef\u53e3=8888, \u5730\u5740=0.0.0.0"),this.socket=s.default.createSocket({type:'udp4',reusePort:!0}),this.socket.on('message',(o,t)=>{try{const s='string'==typeof o?o:o.toString('utf8'),e=JSON.parse(s);if(console.log(`\ud83d\udce8 \u6536\u5230\u5e7f\u64ad\u6d88\u606f from ${t.address}:${t.port}`,{roomId:e.roomId,roomName:e.roomName,hostIP:e.hostIP}),this.isValidRoomBroadcast(e)){const o=!this.discoveredRooms.has(e.roomId);this.discoveredRooms.set(e.roomId,e),o?console.log(`\u2728 \u53d1\u73b0\u65b0\u623f\u95f4: ${e.roomName} (${e.hostIP}:${e.tcpPort})`):console.log(`\ud83d\udd04 \u66f4\u65b0\u623f\u95f4\u4fe1\u606f: ${e.roomName}`);const t=this.roomTimeouts.get(e.roomId);t&&clearTimeout(t);const s=setTimeout(()=>{this.discoveredRooms.delete(e.roomId),this.roomTimeouts.delete(e.roomId),console.log(`\u23f1\ufe0f \u623f\u95f4\u8d85\u65f6\u79fb\u9664: ${e.roomName} (8\u79d2\u672a\u6536\u5230\u5e7f\u64ad)`),this.notifyRoomsUpdate()},8e3);this.roomTimeouts.set(e.roomId,s),this.notifyRoomsUpdate()}else console.warn('\u26a0\ufe0f \u6536\u5230\u7684\u5e7f\u64ad\u6d88\u606f\u683c\u5f0f\u4e0d\u5b8c\u6574:',e)}catch(t){console.error('\u274c \u89e3\u6790\u5e7f\u64ad\u6d88\u606f\u5931\u8d25:',t),console.error('\u539f\u59cb\u6d88\u606f:','string'==typeof o?o:o.toString('utf8'))}}),this.socket.on('error',o=>{const t=o?.code||'UNKNOWN',s=o?.message||o?.toString()||'\u672a\u77e5\u9519\u8bef';console.error('\u274c UDP Socket \u9519\u8bef:',{code:t,message:s,port:c}),'EADDRINUSE'===t?(console.warn("\u26a0\ufe0f UDP \u7aef\u53e3 8888 \u88ab\u5360\u7528"),console.warn('\ud83d\udca1 \u5efa\u8bae: \u68c0\u67e5\u662f\u5426\u6709\u5176\u4ed6\u5e94\u7528\u5360\u7528\u4e86\u7aef\u53e3 8888\uff0c\u6216\u8005\u91cd\u542f\u5e94\u7528')):'EACCES'===t?(console.error('\u274c \u6743\u9650\u88ab\u62d2\u7edd - \u53ef\u80fd\u9700\u8981\u7f51\u7edc\u6743\u9650'),console.error('\ud83d\udca1 \u5efa\u8bae: \u68c0\u67e5\u5e94\u7528\u7684\u7f51\u7edc\u6743\u9650\u8bbe\u7f6e')):'ENETUNREACH'===t&&(console.error('\u274c \u7f51\u7edc\u4e0d\u53ef\u8fbe'),console.error('\ud83d\udca1 \u5efa\u8bae: \u68c0\u67e5\u8bbe\u5907\u662f\u5426\u8fde\u63a5\u5230 WiFi \u7f51\u7edc'));const e=setTimeout(()=>{console.log('\ud83d\udd04 \u5c1d\u8bd5\u91cd\u65b0\u542f\u52a8UDP\u76d1\u542c\u5668...'),this.stopListening(),this.startListening(this.onRoomDiscoveredCallback||void 0),this.timers.delete(e)},3e3);this.timers.add(e)});try{console.log("\ud83d\udd27 \u5f00\u59cb\u7ed1\u5b9a\u5230\u7aef\u53e3 8888..."),this.socket.bind({port:c,address:'0.0.0.0'},()=>{console.log("\u2705 \u6210\u529f\u7ed1\u5b9a\u5230 UDP \u7aef\u53e3 8888"),console.log("\ud83c\udfa7 \u5f00\u59cb\u76d1\u542c UDP \u5e7f\u64ad (\u5730\u5740: 0.0.0.0:8888)");try{this.socket?.setBroadcast(!0);try{this.socket?.setMulticastLoopback(!0),this.socket?.setMulticastTTL(255),console.log('\u2705 \u591a\u64ad\u9009\u9879\u8bbe\u7f6e\u6210\u529f')}catch(o){console.warn('\u26a0\ufe0f \u8bbe\u7f6e\u591a\u64ad\u9009\u9879\u5931\u8d25 (\u53ef\u5ffd\u7565):',o?.message)}console.log('\u2705 UDP \u5e7f\u64ad\u63a5\u6536\u5df2\u542f\u7528'),console.log('\ud83d\udce1 \u6b63\u5728\u7b49\u5f85\u623f\u95f4\u5e7f\u64ad...')}catch(o){console.error('\u274c \u8bbe\u7f6e\u5e7f\u64ad\u9009\u9879\u5931\u8d25:',o?.message||o),console.error('\ud83d\udca1 \u8fd9\u53ef\u80fd\u5bfc\u81f4\u65e0\u6cd5\u63a5\u6536\u5e7f\u64ad\u6d88\u606f')}})}catch(o){const t=o?.message||o?.toString()||'\u672a\u77e5\u9519\u8bef';throw console.error('\u274c \u7ed1\u5b9a UDP \u7aef\u53e3\u5931\u8d25:',t),console.error('\ud83d\udca1 \u5efa\u8bae:'),console.error('  1. \u68c0\u67e5\u7aef\u53e3 8888 \u662f\u5426\u88ab\u5176\u4ed6\u5e94\u7528\u5360\u7528'),console.error('  2. \u68c0\u67e5\u5e94\u7528\u662f\u5426\u6709\u7f51\u7edc\u6743\u9650'),console.error('  3. \u5c1d\u8bd5\u91cd\u542f\u5e94\u7528'),o}}}stopListening(){if(console.log('\ud83d\uded1 \u505c\u6b62\u76d1\u542c UDP \u5e7f\u64ad...'),this.clearAllTimers(),this.roomTimeouts.forEach(o=>{try{clearTimeout(o)}catch(o){console.warn('\u6e05\u7406\u8d85\u65f6\u5b9a\u65f6\u5668\u5931\u8d25:',o)}}),this.roomTimeouts.clear(),this.discoveredRooms.clear(),this.socket){try{this.socket.removeAllListeners?.(),this.socket.close(),console.log('\u2705 UDP Socket \u5df2\u5173\u95ed')}catch(o){console.warn('\u26a0\ufe0f \u5173\u95ed UDP Socket \u5931\u8d25:',o)}this.socket=null}this.onRoomDiscoveredCallback=null,console.log('\u2705 \u505c\u6b62\u76d1\u542c\u5b8c\u6210')}async startBroadcasting(o){if(this.broadcastInterval)console.log('\u26a0\ufe0f \u5df2\u7ecf\u5728\u5e7f\u64ad\u4e2d');else{if(this.roomInfo=o,console.log('\ud83d\udce1 \u521b\u5efa UDP Socket \u7528\u4e8e\u5e7f\u64ad\u623f\u95f4\u4fe1\u606f...'),!this.socket)try{await this.createBroadcastSocket()}catch(o){throw console.error('\u274c \u521b\u5efa\u5e7f\u64ad socket \u5931\u8d25:',o),o}this.broadcastInterval=setInterval(()=>{this.broadcast()},2e3),this.broadcast(),console.log(`\ud83d\udce1 \u5f00\u59cb\u5e7f\u64ad\u623f\u95f4: ${o.roomName} (${o.hostIP}:${o.tcpPort})`)}}createBroadcastSocket(){return new Promise((o,t)=>{console.log('\ud83d\udd27 \u6b63\u5728\u521b\u5efa UDP \u5e7f\u64ad socket...');const e=s.default.createSocket({type:'udp4',reusePort:!0});let c=!1;e.on('error',o=>{console.error('\u274c UDP \u5e7f\u64ad Socket \u9519\u8bef:',o),c||(c=!0,t(o))}),e.bind(()=>{console.log('\u2705 UDP \u5e7f\u64ad socket \u7ed1\u5b9a\u6210\u529f');try{e.setBroadcast(!0),console.log('\u2705 UDP \u5e7f\u64ad\u6a21\u5f0f\u5df2\u542f\u7528');try{e.setTTL&&e.setTTL(64),e.setMulticastTTL&&e.setMulticastTTL(64),console.log('\u2705 UDP socket\u9009\u9879\u8bbe\u7f6e\u5b8c\u6210')}catch(o){console.warn('\u26a0\ufe0f \u8bbe\u7f6eUDP socket\u9009\u9879\u5931\u8d25\uff0c\u4f46\u4e0d\u5f71\u54cd\u57fa\u672c\u529f\u80fd:',o)}this.socket=e,c||(c=!0,o())}catch(o){console.error('\u274c \u8bbe\u7f6e\u5e7f\u64ad\u6a21\u5f0f\u5931\u8d25:',o),c||(c=!0,t(o))}});const n=setTimeout(()=>{if(!c){c=!0;const o=new Error('UDP \u5e7f\u64ad socket \u521d\u59cb\u5316\u8d85\u65f6');console.error('\u23f1\ufe0f',o.message),t(o)}this.timers.delete(n)},3e3);this.timers.add(n)})}stopBroadcasting(){if(console.log('\ud83d\uded1 \u505c\u6b62\u5e7f\u64ad\u623f\u95f4...'),this.clearAllTimers(),this.broadcastInterval){try{clearInterval(this.broadcastInterval),console.log('\u2705 \u5e7f\u64ad\u5b9a\u65f6\u5668\u5df2\u505c\u6b62')}catch(o){console.warn('\u26a0\ufe0f \u6e05\u7406\u5e7f\u64ad\u5b9a\u65f6\u5668\u5931\u8d25:',o)}this.broadcastInterval=null}if(this.roomInfo=null,this.socket){try{this.socket.removeAllListeners?.(),this.socket.close(),console.log('\u2705 UDP Socket \u5df2\u5173\u95ed')}catch(o){console.warn('\u26a0\ufe0f \u5173\u95ed UDP Socket \u5931\u8d25:',o)}this.socket=null}this.broadcastFailureCount=0,this.isSocketHealthy=!0,console.log('\u2705 \u505c\u6b62\u5e7f\u64ad\u5b8c\u6210')}async broadcast(){if(this.socket&&this.roomInfo){if(!this.isSocketHealthy)return console.warn('\u26a0\ufe0f Socket \u4e0d\u5065\u5eb7\uff0c\u5c1d\u8bd5\u91cd\u5efa...'),void await this.rebuildBroadcastSocket();try{this.roomInfo.timestamp=Date.now();const o=JSON.stringify(this.roomInfo),t=e.Buffer.from(o,'utf8'),s=['255.255.255.255','192.168.255.255','10.255.255.255','172.31.255.255'];let n=0,l=0;for(const o of s)try{await new Promise((s,e)=>{this.socket.send(t,0,t.length,c,o,t=>{t?(console.warn(`\u26a0\ufe0f \u5e7f\u64ad\u5230 ${o} \u5931\u8d25:`,t.message),l++,e(t)):(n++,s())})})}catch(o){continue}n>0?this.broadcastFailureCount>0&&(console.log(`\u2705 \u5e7f\u64ad\u6062\u590d\u6b63\u5e38 (\u6210\u529f: ${n}, \u5931\u8d25: ${l})`),this.broadcastFailureCount=0):(this.broadcastFailureCount++,console.error(`\u274c \u6240\u6709\u5e7f\u64ad\u5730\u5740\u90fd\u5931\u8d25 (${this.broadcastFailureCount}/${this.maxBroadcastFailures})`),this.broadcastFailureCount>=this.maxBroadcastFailures&&(console.error('\u274c \u5e7f\u64ad\u5931\u8d25\u6b21\u6570\u8fc7\u591a\uff0c\u6807\u8bb0 socket \u4e3a\u4e0d\u5065\u5eb7'),this.isSocketHealthy=!1,this.broadcastFailureCount=0))}catch(o){this.broadcastFailureCount++,console.error(`\u274c \u5e7f\u64ad\u6d88\u606f\u5f02\u5e38 (${this.broadcastFailureCount}/${this.maxBroadcastFailures}):`,o),this.broadcastFailureCount>=this.maxBroadcastFailures&&(console.error('\u274c \u5e7f\u64ad\u5931\u8d25\u6b21\u6570\u8fc7\u591a\uff0c\u6807\u8bb0 socket \u4e3a\u4e0d\u5065\u5eb7'),this.isSocketHealthy=!1,this.broadcastFailureCount=0)}}else console.warn('\u26a0\ufe0f \u65e0\u6cd5\u5e7f\u64ad: socket\u6216roomInfo\u4e0d\u5b58\u5728')}async rebuildBroadcastSocket(){if(console.log('\ud83d\udd27 \u5f00\u59cb\u91cd\u5efa\u5e7f\u64ad socket...'),this.socket){try{this.socket.close()}catch(o){console.warn('\u5173\u95ed\u65e7 socket \u5931\u8d25:',o)}this.socket=null}try{await this.createBroadcastSocket(),this.isSocketHealthy=!0,this.broadcastFailureCount=0,console.log('\u2705 \u5e7f\u64ad socket \u91cd\u5efa\u6210\u529f')}catch(o){console.error('\u274c \u91cd\u5efa\u5e7f\u64ad socket \u5931\u8d25:',o);const t=setTimeout(()=>{this.broadcastInterval&&this.rebuildBroadcastSocket(),this.timers.delete(t)},5e3);this.timers.add(t)}}updateRoomInfo(o){this.roomInfo&&(this.roomInfo={...this.roomInfo,...o})}getDiscoveredRooms(){return Array.from(this.discoveredRooms.values())}notifyRoomsUpdate(){this.onRoomDiscoveredCallback&&this.onRoomDiscoveredCallback(this.getDiscoveredRooms())}cleanup(){this.stopBroadcasting(),this.stopListening(),this.broadcastFailureCount=0,this.isSocketHealthy=!0}isValidRoomBroadcast(o){if(!o||'object'!=typeof o)return!1;const t=o;return'string'==typeof t.roomId&&'string'==typeof t.roomName&&'string'==typeof t.hostName&&'string'==typeof t.hostIP&&'number'==typeof t.tcpPort&&'number'==typeof t.maxPlayers&&'number'==typeof t.currentPlayers&&'string'==typeof t.gameType&&'number'==typeof t.timestamp}getStatus(){return{isBroadcasting:null!==this.broadcastInterval,isListening:null!==this.socket&&null===this.broadcastInterval,socketHealthy:this.isSocketHealthy,broadcastFailures:this.broadcastFailureCount,discoveredRoomsCount:this.discoveredRooms.size,roomInfo:this.roomInfo?{roomName:this.roomInfo.roomName,hostIP:this.roomInfo.hostIP,tcpPort:this.roomInfo.tcpPort}:null}}async diagnoseNetwork(){const o=[],t=[];if(console.log('\ud83d\udd0d \u5f00\u59cb\u7f51\u7edc\u8bca\u65ad...'),this.socket||(o.push('UDP Socket \u672a\u521b\u5efa'),t.push('\u8bf7\u5148\u8c03\u7528 startListening() \u6216 startBroadcasting()')),this.isSocketHealthy||(o.push('UDP Socket \u4e0d\u5065\u5eb7\uff08\u9891\u7e41\u5931\u8d25\uff09'),t.push('\u53ef\u80fd\u662f\u7f51\u7edc\u4e0d\u7a33\u5b9a\u6216\u9632\u706b\u5899\u963b\u6b62\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc\u8bbe\u7f6e')),this.broadcastFailureCount>0&&(o.push(`\u5e7f\u64ad\u5931\u8d25 ${this.broadcastFailureCount} \u6b21`),t.push('\u68c0\u67e5\u8bbe\u5907\u662f\u5426\u5728\u540c\u4e00 WiFi \u7f51\u7edc\uff0c\u8def\u7531\u5668\u662f\u5426\u652f\u6301\u5e7f\u64ad')),0===this.discoveredRooms.size&&null===this.broadcastInterval&&(o.push('\u672a\u53d1\u73b0\u4efb\u4f55\u623f\u95f4'),t.push('\u786e\u4fdd\u623f\u4e3b\u5df2\u5f00\u542f\u623f\u95f4\uff0c\u4e14\u53cc\u65b9\u5728\u540c\u4e00 WiFi \u7f51\u7edc'),t.push('\u68c0\u67e5\u8def\u7531\u5668\u662f\u5426\u5f00\u542f\u4e86 AP \u9694\u79bb\u529f\u80fd')),this.socket)try{const s=JSON.stringify({test:!0,timestamp:Date.now()}),n=e.Buffer.from(s,'utf8');await new Promise((s,e)=>{this.socket.send(n,0,n.length,c,'255.255.255.255',c=>{c?(o.push(`\u6d4b\u8bd5\u5e7f\u64ad\u5931\u8d25: ${c.message||c}`),t.push('\u53ef\u80fd\u662f\u9632\u706b\u5899\u963b\u6b62\u6216\u7aef\u53e3\u88ab\u5360\u7528'),e(c)):(console.log('\u2705 \u6d4b\u8bd5\u5e7f\u64ad\u53d1\u9001\u6210\u529f'),s())});const l=setTimeout(()=>{e(new Error('\u6d4b\u8bd5\u8d85\u65f6')),this.timers.delete(l)},2e3);this.timers.add(l)})}catch(s){o.push(`Socket \u6d4b\u8bd5\u5931\u8d25: ${s.message}`),t.push('\u8bf7\u68c0\u67e5\u7f51\u7edc\u6743\u9650\u548c\u9632\u706b\u5899\u8bbe\u7f6e')}const s=0===o.length;return console.log('\ud83d\udd0d \u8bca\u65ad\u5b8c\u6210:',{success:s,issues:o,suggestions:t}),{success:s,issues:o,suggestions:t}}}},1205,[1202,1801]);
__d(function(g,r,i,a,m,_e,d){"use strict";Object.defineProperty(_e,'__esModule',{value:!0}),Object.defineProperty(_e,"tcpServer",{enumerable:!0,get:function(){return n}});var e,t=r(d[0]),s=(e=t)&&e.__esModule?e:{default:e};const n=new class{server=null;clients=new Map;port=3306;eventListeners=new Map;messageBuffer=new Map;timers=new Set;clearAllTimers(){console.log(`\ud83e\uddf9 [TCPServer] \u6e05\u7406 ${this.timers.size} \u4e2a\u6d3b\u8dc3\u5b9a\u65f6\u5668`),this.timers.forEach(e=>{try{clearTimeout(e)}catch(e){console.warn('\u6e05\u7406\u5b9a\u65f6\u5668\u5931\u8d25:',e)}}),this.timers.clear()}async start(e=3306){return this.server&&(console.log('\u26a0\ufe0f TCP Server \u5df2\u7ecf\u5728\u8fd0\u884c\uff0c\u5148\u505c\u6b62...'),await this.stop(),await new Promise(e=>setTimeout(e,500))),new Promise((t,n)=>{this.port=e;let o=0;const l=e=>{this.server=s.default.createServer(e=>{this.handleNewConnection(e)}),this.server.on('error',t=>{const s=t?.message||t?.toString()||JSON.stringify(t),c=t?.code||'UNKNOWN';if(console.error(`TCP Server \u9519\u8bef (\u7aef\u53e3 ${e}):`,s),console.error("\u9519\u8bef\u4ee3\u7801:",c),console.error("\u5b8c\u6574\u9519\u8bef\u5bf9\u8c61:",t),'EADDRINUSE'===c&&o<10){o++;const t=e+1;if(console.log(`\u26a0\ufe0f \u7aef\u53e3 ${e} \u88ab\u5360\u7528\uff0c\u5c1d\u8bd5\u7aef\u53e3 ${t}...`),this.server){try{this.server.close()}catch(e){console.warn('\u5173\u95ed\u670d\u52a1\u5668\u65f6\u51fa\u9519:',e)}this.server=null}const s=setTimeout(()=>{l(t),this.timers.delete(s)},200);this.timers.add(s)}else{const e=new Error(`TCP Server \u542f\u52a8\u5931\u8d25: ${s} (code: ${c})`);n(e)}});try{this.server.listen({port:e,host:'0.0.0.0'},()=>{this.port=e,console.log(`\ud83d\ude80 TCP Server \u542f\u52a8\u6210\u529f\uff0c\u76d1\u542c\u7aef\u53e3: ${this.port}`),t(this.port)})}catch(t){const s=t?.message||t?.toString()||JSON.stringify(t),c=t?.code||'UNKNOWN';if(console.error(`TCP Server \u76d1\u542c\u5931\u8d25 (\u7aef\u53e3 ${e}):`,s),'EADDRINUSE'===c&&o<10){o++;const t=e+1;if(console.log(`\u26a0\ufe0f \u7aef\u53e3 ${e} \u88ab\u5360\u7528\uff0c\u5c1d\u8bd5\u7aef\u53e3 ${t}...`),this.server){try{this.server.close()}catch(e){console.warn('\u5173\u95ed\u670d\u52a1\u5668\u65f6\u51fa\u9519:',e)}this.server=null}const s=setTimeout(()=>{l(t),this.timers.delete(s)},200);this.timers.add(s)}else{const e=new Error(`TCP Server \u542f\u52a8\u5931\u8d25: ${s} (code: ${c})`);n(e)}}};l(e)})}stop(){return new Promise(e=>{if(console.log('\ud83d\uded1 \u505c\u6b62 TCP Server...'),this.clearAllTimers(),this.clients.forEach(e=>{try{e.socket.destroy()}catch(e){console.warn('\u5173\u95ed\u5ba2\u6237\u7aef\u8fde\u63a5\u5931\u8d25:',e)}}),this.clients.clear(),this.messageBuffer.clear(),this.server)try{this.server.close(()=>{console.log('\u2705 TCP Server \u5df2\u505c\u6b62'),this.server=null,e()})}catch(t){console.warn('\u5173\u95ed\u670d\u52a1\u5668\u5931\u8d25:',t),this.server=null,e()}else console.log('\u2705 TCP Server \u5df2\u505c\u6b62\uff08\u65e0\u6d3b\u52a8\u670d\u52a1\u5668\uff09'),e()})}handleNewConnection(e){const t=`${e.remoteAddress}:${e.remotePort}`;console.log(`\ud83d\udcf1 \u65b0\u5ba2\u6237\u7aef\u8fde\u63a5: ${t}`);const s=`temp_${Date.now()}_${Math.random().toString(36).substring(7)}`,n={playerId:s,socket:e,isConnected:!0};this.clients.set(s,n),this.messageBuffer.set(s,'');let o=s;e.on('data',e=>{this.handleClientData(o,e)}),e.on('close',e=>{console.log(`\ud83d\udc4b \u5ba2\u6237\u7aef\u65ad\u5f00: ${t}`,e?`\u9519\u8bef: ${e}`:''),this.handleClientDisconnect(o)}),e.on('error',e=>{console.error(`\u274c \u5ba2\u6237\u7aef\u9519\u8bef ${t}:`,e)}),this.emit('client:connected',{clientId:s}),e.__updateClientId=e=>{console.log(`\ud83d\udc1b [DEBUG] \u66f4\u65b0 socket \u7684 clientId \u5f15\u7528: ${o} -> ${e}`),o=e}}handleClientData(e,t){try{if(!this.clients.get(e))return;console.log(`\ud83d\udc1b [DEBUG] \u6536\u5230\u539f\u59cb\u6570\u636e [${e}]: ${t.length} \u5b57\u8282`);let s=this.messageBuffer.get(e)||'';s+=t.toString('utf8'),console.log(`\ud83d\udc1b [DEBUG] \u5f53\u524d\u7f13\u51b2\u533a\u5927\u5c0f: ${s.length} \u5b57\u8282`);const n=s.split('\n');console.log(`\ud83d\udc1b [DEBUG] \u5206\u5272\u540e\u7684\u6d88\u606f\u6570: ${n.length}`),s=n.pop()||'',this.messageBuffer.set(e,s),console.log(`\ud83d\udc1b [DEBUG] \u4fdd\u7559\u5728\u7f13\u51b2\u533a: ${s.length} \u5b57\u8282`);for(const t of n)if(t.trim()){console.log(`\ud83d\udc1b [DEBUG] \u5c1d\u8bd5\u89e3\u6790\u6d88\u606f: ${t.substring(0,100)}...`);try{const s=JSON.parse(t);console.log(`\ud83d\udc1b [DEBUG] \u6d88\u606f\u89e3\u6790\u6210\u529f: type=${s.type}, event=${s.event}`),this.handleClientMessage(e,s)}catch(e){console.error('\u89e3\u6790\u6d88\u606f\u5931\u8d25:',e,'Message:',t)}}}catch(e){console.error('\u5904\u7406\u5ba2\u6237\u7aef\u6570\u636e\u5931\u8d25:',e)}}handleClientMessage(e,t){if(console.log(`\ud83d\udce8 \u6536\u5230\u6d88\u606f [${e}]:`,JSON.stringify({type:t.type,event:t.event,playerId:t.playerId})),console.log("\ud83d\udc1b [DEBUG] \u5f00\u59cb\u5904\u7406\u6d88\u606f"),console.log(`\ud83d\udc1b [DEBUG] message.playerId: ${t.playerId}`),console.log(`\ud83d\udc1b [DEBUG] \u5f53\u524d clientId: ${e}`),t.playerId){const s=this.clients.get(e);if(console.log(`\ud83d\udc1b [DEBUG] client \u5b58\u5728: ${!!s}`),console.log(`\ud83d\udc1b [DEBUG] client.playerId: ${s?.playerId}`),s&&s.playerId!==t.playerId){console.log(`\ud83d\udd04 \u9700\u8981\u66f4\u65b0\u5ba2\u6237\u7aefID: ${e} -> ${t.playerId}`),s.socket&&'function'==typeof s.socket.__updateClientId&&s.socket.__updateClientId(t.playerId),this.clients.delete(e);const n=this.messageBuffer.get(e)||'';this.messageBuffer.delete(e),s.playerId=t.playerId,this.clients.set(t.playerId,s),this.messageBuffer.set(t.playerId,n),console.log(`\u2705 \u5ba2\u6237\u7aefID\u5df2\u66f4\u65b0: ${e} -> ${t.playerId}`),e=t.playerId}}if('event'===t.type&&'client:init'===t.event){console.log(`\u2705 \u5ba2\u6237\u7aef\u521d\u59cb\u5316\u5b8c\u6210: ${t.playerId||e}`);const s=t.playerId||e,n=this.sendToClient(s,{type:'event',event:'server:init_ack',data:{success:!0,serverId:this.port,timestamp:Date.now()}});return void console.log(`\ud83d\udce4 \u53d1\u9001\u521d\u59cb\u5316\u786e\u8ba4\u5230\u5ba2\u6237\u7aef [${s}]: ${n?'\u6210\u529f':'\u5931\u8d25'}`)}'event'===t.type&&t.event&&(console.log(`\ud83d\udd14 \u89e6\u53d1\u4e8b\u4ef6: ${t.event}`),console.log(`\ud83d\udc1b [DEBUG] \u4e8b\u4ef6\u76d1\u542c\u5668\u6570\u91cf: ${this.eventListeners.get(t.event)?.size||0}`),this.emit(t.event,{playerId:t.playerId||e,data:t.data,requestId:t.requestId}),console.log("\ud83d\udc1b [DEBUG] \u4e8b\u4ef6\u89e6\u53d1\u5b8c\u6210"))}handleClientDisconnect(e){const t=this.clients.get(e);t&&(t.isConnected=!1,this.clients.delete(e),this.messageBuffer.delete(e),this.emit('client:disconnected',{playerId:t.playerId}))}sendToClient(e,t){const s=this.clients.get(e);if(!s||!s.isConnected)return console.warn(`\u26a0\ufe0f \u5ba2\u6237\u7aef\u672a\u8fde\u63a5: ${e}`),!1;try{const e=JSON.stringify(t)+'\n';return s.socket.write(e),!0}catch(t){return console.error(`\u53d1\u9001\u6d88\u606f\u5931\u8d25 [${e}]:`,t),!1}}broadcast(e,t){this.clients.forEach((s,n)=>{n!==t&&this.sendToClient(n,e)})}getConnectedClients(){return Array.from(this.clients.keys()).filter(e=>this.clients.get(e)?.isConnected)}getClientCount(){return this.getConnectedClients().length}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(s=>{try{s(t)}catch(t){console.error(`\u4e8b\u4ef6\u5904\u7406\u5668\u9519\u8bef [${e}]:`,t)}})}getStatus(){return{isRunning:null!==this.server,port:this.port,clientCount:this.getClientCount(),connectedClients:this.getConnectedClients()}}}},1208,[1195]);
__d(function(g,r,i,a,m,_e,d){"use strict";Object.defineProperty(_e,'__esModule',{value:!0}),Object.defineProperty(_e,"tcpClient",{enumerable:!0,get:function(){return n}});var e,t=r(d[0]),s=(e=t)&&e.__esModule?e:{default:e};const n=new class{socket=null;isConnected=!1;eventListeners=new Map;messageBuffer='';reconnectAttempts=0;maxReconnectAttempts=3;reconnectInterval=null;hostIP='';hostPort=0;playerId='';shouldReconnect=!0;isManualDisconnect=!1;pendingResolve=null;pendingReject=null;timers=new Set;clearAllTimers(){console.log(`\ud83e\uddf9 [TCPClient] \u6e05\u7406 ${this.timers.size} \u4e2a\u6d3b\u8dc3\u5b9a\u65f6\u5668`),this.timers.forEach(e=>{try{clearTimeout(e)}catch(e){console.warn('\u6e05\u7406\u5b9a\u65f6\u5668\u5931\u8d25:',e)}}),this.timers.clear()}connect(e,t,n){return new Promise((o,c)=>{if(this.socket&&this.isConnected)return console.log('\u26a0\ufe0f \u5df2\u7ecf\u8fde\u63a5\u5230\u670d\u52a1\u5668'),void o();if(this.socket){console.log('\ud83e\uddf9 \u6e05\u7406\u65e7\u7684socket\u8fde\u63a5');try{this.socket.destroy()}catch(e){console.warn('\u6e05\u7406\u65e7socket\u5931\u8d25:',e)}this.socket=null}this.hostIP=e,this.hostPort=t,this.playerId=n,this.shouldReconnect=!0,this.isManualDisconnect=!1,this.pendingResolve=o,this.pendingReject=c,console.log(`\ud83d\udd0c [${n.substring(0,8)}] \u8fde\u63a5\u5230\u623f\u4e3b TCP \u670d\u52a1\u5668: ${e}:${t}`),this.socket=s.default.createConnection({host:e,port:t},()=>{console.log(`\u2705 [${this.playerId.substring(0,8)}] TCP Socket \u8fde\u63a5\u5efa\u7acb`),this.isConnected=!0,this.reconnectAttempts=0,this.isManualDisconnect=!1,console.log(`\ud83d\udce4 [${this.playerId.substring(0,8)}] \u53d1\u9001 client:init \u6d88\u606f`),this.send({type:'event',event:'client:init',playerId:this.playerId,data:{playerId:this.playerId}}),this.emit('connected',{}),this.pendingResolve&&(this.pendingResolve(),this.pendingResolve=null,this.pendingReject=null)}),this.socket.on('data',e=>{this.handleServerData(e)}),this.socket.on('close',e=>{console.log(`\ud83d\udc4b [${this.playerId.substring(0,8)}] TCP Socket \u5173\u95ed`,e?`\u9519\u8bef: ${JSON.stringify(e)}`:''),this.handleDisconnect()}),this.socket.on('error',e=>{console.error(`\u274c [${this.playerId.substring(0,8)}] TCP \u8fde\u63a5\u9519\u8bef:`,e),this.isConnected=!1,this.emit('error',{error:e}),!this.isConnected&&this.pendingReject&&(this.pendingReject(e),this.pendingResolve=null,this.pendingReject=null)});const h=setTimeout(()=>{if(!this.isConnected&&this.pendingReject){const e=new Error('\u8fde\u63a5\u8d85\u65f6');console.error(`\u23f1\ufe0f [${this.playerId.substring(0,8)}] \u8fde\u63a5\u8d85\u65f6`),this.pendingReject(e),this.pendingResolve=null,this.pendingReject=null}this.timers.delete(h)},12e3);this.timers.add(h)})}disconnect(){if(console.log(`\ud83d\uded1 [${this.playerId.substring(0,8)}] \u4e3b\u52a8\u65ad\u5f00 TCP \u8fde\u63a5`),this.isManualDisconnect=!0,this.shouldReconnect=!1,this.clearAllTimers(),this.reconnectInterval&&(clearTimeout(this.reconnectInterval),this.reconnectInterval=null),this.socket){try{this.socket.destroy()}catch(e){console.warn('\u9500\u6bc1socket\u5931\u8d25:',e)}this.socket=null}this.isConnected=!1,this.messageBuffer='',this.reconnectAttempts=0,this.pendingResolve=null,this.pendingReject=null,this.emit('disconnected',{})}handleServerData(e){try{this.messageBuffer+=e.toString('utf8');const t=this.messageBuffer.split('\n');this.messageBuffer=t.pop()||'';for(const e of t)if(e.trim())try{const t=JSON.parse(e);this.handleServerMessage(t)}catch(t){console.error('\u89e3\u6790\u670d\u52a1\u5668\u6d88\u606f\u5931\u8d25:',t,'Message:',e)}}catch(e){console.error('\u5904\u7406\u670d\u52a1\u5668\u6570\u636e\u5931\u8d25:',e)}}handleServerMessage(e){console.log(`\ud83d\udce8 [${this.playerId.substring(0,8)}] \u6536\u5230\u670d\u52a1\u5668\u6d88\u606f:`,JSON.stringify({type:e.type,event:e.event})),'broadcast'===e.type&&e.event?this.emit(e.event,e.data):'response'===e.type&&e.requestId?this.emit(`response:${e.requestId}`,e.data):'event'===e.type&&e.event&&(console.log(`\ud83d\udd14 [${this.playerId.substring(0,8)}] \u89e6\u53d1\u4e8b\u4ef6: ${e.event}`),this.emit(e.event,e.data))}handleDisconnect(){const e=this.isConnected;if(this.isConnected=!1,console.log(`\u26a0\ufe0f [${this.playerId.substring(0,8)}] \u8fde\u63a5\u65ad\u5f00 (\u624b\u52a8=${this.isManualDisconnect}, \u5141\u8bb8\u91cd\u8fde=${this.shouldReconnect}, \u5c1d\u8bd5\u6b21\u6570=${this.reconnectAttempts}/${this.maxReconnectAttempts})`),this.emit('disconnected',{}),!this.isManualDisconnect&&this.shouldReconnect&&this.reconnectAttempts<this.maxReconnectAttempts&&e){if(this.socket&&!this.socket.destroyed&&this.socket.writable)return console.log(`\u2139\ufe0f [${this.playerId.substring(0,8)}] Socket\u4ecd\u7136\u53ef\u7528\uff0c\u8df3\u8fc7\u91cd\u8fde`),void(this.isConnected=!0);this.reconnectAttempts++,console.log(`\ud83d\udd04 [${this.playerId.substring(0,8)}] \u51c6\u5907\u91cd\u8fde (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`),this.reconnectInterval=setTimeout(()=>{console.log(`\ud83d\udd04 [${this.playerId.substring(0,8)}] \u5f00\u59cb\u7b2c ${this.reconnectAttempts} \u6b21\u91cd\u8fde...`),this.connect(this.hostIP,this.hostPort,this.playerId).catch(e=>{console.error(`\u274c [${this.playerId.substring(0,8)}] \u7b2c ${this.reconnectAttempts} \u6b21\u91cd\u8fde\u5931\u8d25:`,e)}),this.reconnectInterval&&this.timers.delete(this.reconnectInterval)},3e3),this.timers.add(this.reconnectInterval)}else this.reconnectAttempts>=this.maxReconnectAttempts?(console.error(`\u274c [${this.playerId.substring(0,8)}] \u91cd\u8fde\u5931\u8d25,\u5df2\u8fbe\u5230\u6700\u5927\u91cd\u8fde\u6b21\u6570`),this.shouldReconnect=!1,this.emit('reconnect_failed',{})):console.log(`\u2139\ufe0f [${this.playerId.substring(0,8)}] \u4e0d\u8fdb\u884c\u91cd\u8fde (\u624b\u52a8=${this.isManualDisconnect})`)}send(e){if(!this.socket||!this.isConnected)return console.warn('\u26a0\ufe0f \u672a\u8fde\u63a5\u5230\u670d\u52a1\u5668'),!1;try{const t={...e,playerId:this.playerId},s=JSON.stringify(t)+'\n';return this.socket.write(s),!0}catch(e){return console.error('\u53d1\u9001\u6d88\u606f\u5931\u8d25:',e),!1}}sendEvent(e,t,s){const n=s?`${Date.now()}_${Math.random().toString(36).substring(7)}`:void 0;if(s&&n){const e=t=>{this.off(`response:${n}`,e),s(t)};this.on(`response:${n}`,e);const t=setTimeout(()=>{this.off(`response:${n}`,e),this.timers.delete(t)},3e4);this.timers.add(t)}this.send({type:'event',event:e,data:t,requestId:n})}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t)}off(e,t){const s=this.eventListeners.get(e);s&&s.delete(t)}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(s=>{try{s(t)}catch(t){console.error(`\u4e8b\u4ef6\u5904\u7406\u5668\u9519\u8bef [${e}]:`,t)}})}getIsConnected(){return this.isConnected}getStatus(){return{isConnected:this.isConnected,hostIP:this.hostIP,hostPort:this.hostPort,playerId:this.playerId,reconnectAttempts:this.reconnectAttempts}}}},1209,[1195]);