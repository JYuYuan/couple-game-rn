__d(function(g,r,i,a,m,_e,d){"use strict";function e(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(_e,'__esModule',{value:!0}),Object.defineProperty(_e,"lanService",{enumerable:!0,get:function(){return h}});var t=r(d[0]),o=r(d[1]),n=r(d[2]),s=r(d[3]),c=e(r(d[4])),l=e(r(d[5])),p=e(r(d[6]));class u{isHost=!1;currentPlayerId='';currentRoom=null;eventListeners=new Map;localIP='';timers=new Set;tcpServerHandlers=new Map;tcpClientHandlers=new Map;constructor(){}clearAllTimers(){console.log(`\ud83e\uddf9 [LANService] \u6e05\u7406 ${this.timers.size} \u4e2a\u6d3b\u8dc3\u5b9a\u65f6\u5668`),this.timers.forEach(e=>{try{clearTimeout(e)}catch(e){console.warn('\u6e05\u7406\u5b9a\u65f6\u5668\u5931\u8d25:',e)}}),this.timers.clear()}static getInstance(){return u.instance||(u.instance=new u),u.instance}async initialize(e){this.currentPlayerId=e,console.log('\ud83c\udf10 \u521d\u59cb\u5316 LAN \u670d\u52a1, PlayerId:',e);const t=await(0,s.getLocalIP)();if(!t)throw new Error('\u65e0\u6cd5\u83b7\u53d6\u672c\u5730 IP \u5730\u5740,\u8bf7\u68c0\u67e5\u7f51\u7edc\u8fde\u63a5');this.localIP=t,console.log('\ud83d\udccd \u672c\u5730 IP:',t)}async createRoom(e,n){console.log('\ud83c\udfe0 \u521b\u5efa\u5c40\u57df\u7f51\u623f\u95f4...'),this.localIP||await this.initialize(this.currentPlayerId),this.isHost=!0;const s=n||3306,p=await o.tcpServer.start(s);console.log(`\u2705 TCP Server \u542f\u52a8: ${this.localIP}:${p}`);let u=await l.default.getPlayer(this.currentPlayerId);u?(u.name=e.playerName,u.isHost=!0,u.avatarId=e.avatarId||'',u.gender=e.gender||'man',u.color||(u.color=this.getRandomColor()),await l.default.updatePlayer(u)):u=await l.default.addPlayer(this.currentPlayerId,{playerId:this.currentPlayerId,name:e.playerName,roomId:null,isHost:!0,socketId:this.currentPlayerId,isConnected:!0,avatarId:e.avatarId||'',gender:e.gender||'man',color:this.getRandomColor()});let h=await c.default.createRoom({name:e.roomName||`Room_${Date.now()}`,hostId:this.currentPlayerId,maxPlayers:e.maxPlayers||2,gameType:e.gameType||'fly',taskSet:e.taskSet||null});const v=await c.default.addPlayerToRoom(h.id,u);if(!v)throw new Error('Failed to add player to room');h=v,u.roomId=h.id,await l.default.updatePlayer(u),this.currentRoom=h,this.setupTCPServerEvents(),console.log('\ud83d\udce1 [LANService] \u51c6\u5907\u5f00\u59cb UDP \u5e7f\u64ad...');const y={roomId:h.id,roomName:h.name,hostName:u.name,hostIP:this.localIP,tcpPort:p,maxPlayers:h.maxPlayers,currentPlayers:h.players.length,gameType:h.gameType,timestamp:Date.now()};console.log('\ud83d\udccb [LANService] \u5e7f\u64ad\u6570\u636e:',JSON.stringify(y));try{await t.udpBroadcastService.startBroadcasting(y),console.log('\u2705 [LANService] UDP \u5e7f\u64ad\u5df2\u542f\u52a8')}catch(e){console.error('\u274c [LANService] \u542f\u52a8 UDP \u5e7f\u64ad\u5931\u8d25:',e),console.error('\ud83d\udca1 \u623f\u95f4\u5df2\u521b\u5efa\uff0c\u4f46\u5176\u4ed6\u8bbe\u5907\u53ef\u80fd\u65e0\u6cd5\u53d1\u73b0\u6b64\u623f\u95f4')}return console.log('\u2705 \u5c40\u57df\u7f51\u623f\u95f4\u521b\u5efa\u6210\u529f'),console.log('\ud83d\udcf1 \u623f\u95f4ID:',h.id),console.log('\ud83c\udf10 \u623f\u4e3bIP:',this.localIP),console.log('\ud83d\udd0c TCP\u7aef\u53e3:',p),this.emit('room:update',h),{...h,connectionType:'lan',networkInfo:{hostIP:this.localIP,port:p},hostIP:this.localIP,tcpPort:p}}async joinRoom(e,t,o){try{return console.log(`\ud83d\udd17 [LANService] \u5f00\u59cb\u52a0\u5165\u5c40\u57df\u7f51\u623f\u95f4: ${e}:${t}`),console.log("\ud83d\udccb [LANService] \u73a9\u5bb6\u4fe1\u606f:",JSON.stringify({playerId:this.currentPlayerId,playerName:o.playerName,avatarId:o.avatarId,gender:o.gender})),this.localIP||(console.log('\u2699\ufe0f [LANService] \u521d\u59cb\u5316\u672c\u5730IP...'),await this.initialize(this.currentPlayerId)),this.isHost=!1,console.log('\ud83c\udfa7 [LANService] \u8bbe\u7f6e TCP Client \u4e8b\u4ef6\u76d1\u542c\u5668...'),this.setupTCPClientEvents(),console.log("\ud83d\udd0c [LANService] \u8fde\u63a5\u5230\u623f\u4e3b TCP \u670d\u52a1\u5668..."),await n.tcpClient.connect(e,t,this.currentPlayerId),console.log('\u2705 [LANService] TCP \u8fde\u63a5\u6210\u529f'),console.log('\ud83d\udce4 [LANService] \u53d1\u9001 room:join \u8bf7\u6c42...'),new Promise((s,c)=>{const l=setTimeout(()=>{console.error('\u23f1\ufe0f [LANService] \u52a0\u5165\u623f\u95f4\u8d85\u65f6 (30\u79d2)'),c(new Error('\u52a0\u5165\u623f\u95f4\u8d85\u65f6\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc\u8fde\u63a5\u6216\u91cd\u8bd5')),this.timers.delete(l)},3e4);this.timers.add(l),console.log('\ud83d\udce4 [LANService] \u8c03\u7528 tcpClient.sendEvent...'),n.tcpClient.sendEvent('room:join',o,o=>{console.log('\ud83d\udce8 [LANService] \u6536\u5230 room:join \u54cd\u5e94:',JSON.stringify(o)),clearTimeout(l),this.timers.delete(l);const n=o;if(n.error)console.error('\u274c [LANService] \u52a0\u5165\u623f\u95f4\u5931\u8d25:',n.error),c(new Error(n.error));else{this.currentRoom=n,console.log('\u2705 [LANService] \u52a0\u5165\u623f\u95f4\u6210\u529f\uff0c\u623f\u95f4ID:',n.id);const o={...n,connectionType:'lan',networkInfo:{hostIP:e,port:t},hostIP:e,tcpPort:t};s(o)}})})}catch(e){const t=e?.message||'Unknown error';throw console.error('\u274c [LANService] \u8fde\u63a5\u5931\u8d25:',t),t.includes('ECONNREFUSED')?new Error('\u65e0\u6cd5\u8fde\u63a5\u5230\u623f\u4e3b\u8bbe\u5907\uff0c\u8bf7\u786e\u8ba4\u623f\u4e3b\u5df2\u521b\u5efa\u623f\u95f4\u4e14\u7f51\u7edc\u8fde\u63a5\u6b63\u5e38'):t.includes('ETIMEDOUT')?new Error('\u8fde\u63a5\u8d85\u65f6\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc\u8fde\u63a5\u6216\u91cd\u8bd5'):e}}async joinRoomByBroadcast(e,t){return this.joinRoom(e.hostIP,e.tcpPort,t)}async leaveRoom(){console.log('\ud83d\udc4b \u79bb\u5f00\u623f\u95f4'),this.isHost?(t.udpBroadcastService.stopBroadcasting(),await o.tcpServer.stop(),this.currentRoom&&(await p.default.removeGameInstance(this.currentRoom.id),await c.default.deleteRoom(this.currentRoom.id))):(n.tcpClient.sendEvent('room:leave',{}),n.tcpClient.disconnect());const e=await l.default.getPlayer(this.currentPlayerId);e&&(e.roomId=null,await l.default.updatePlayer(e)),this.currentRoom=null,this.emit('room:left',{})}startRoomScan(e){console.log('\ud83d\udd0d \u5f00\u59cb\u626b\u63cf\u5c40\u57df\u7f51\u623f\u95f4...'),t.udpBroadcastService.startListening(e)}stopRoomScan(){console.log('\ud83d\uded1 \u505c\u6b62\u626b\u63cf'),t.udpBroadcastService.stopListening()}getDiscoveredRooms(){return t.udpBroadcastService.getDiscoveredRooms()}async startGame(e){if(console.log('\ud83c\udfae [LANService] \u5f00\u59cb\u6e38\u620f\u8bf7\u6c42, roomId:',e.roomId),!this.isHost)throw new Error('\u53ea\u6709\u623f\u4e3b\u53ef\u4ee5\u5f00\u59cb\u6e38\u620f');if(!this.currentRoom)throw new Error('\u5f53\u524d\u4e0d\u5728\u4efb\u4f55\u623f\u95f4\u4e2d');const t=await c.default.getRoom(e.roomId);if(!t)throw new Error('\u623f\u95f4\u4e0d\u5b58\u5728');if(console.log('\ud83d\udccb [LANService] \u623f\u95f4\u73a9\u5bb6\u6570:',t.players.length),t.players.length<2)throw new Error('\u81f3\u5c11\u9700\u89812\u4e2a\u73a9\u5bb6\u624d\u80fd\u5f00\u59cb\u6e38\u620f');console.log('\ud83c\udfae [LANService] \u521b\u5efa\u6e38\u620f\u5b9e\u4f8b...');const o=this.createMockIO(),n=await p.default.createGameInstance(t,o);if(!n)throw new Error('\u6e38\u620f\u521b\u5efa\u5931\u8d25');console.log('\ud83d\ude80 [LANService] \u8c03\u7528 game.onStart()...'),await n.onStart(),console.log('\u2705 [LANService] \u6e38\u620f\u5df2\u5f00\u59cb\uff0c\u72b6\u6001\u5df2\u66f4\u65b0'),this.currentRoom=t}async handleGameAction(e){const t=e.roomId;if(console.log('\ud83c\udfae [LANService] handleGameAction \u8c03\u7528, roomId:',t,'isHost:',this.isHost),!t)throw console.error('\u274c [LANService] roomId \u4e0d\u5b58\u5728!'),new Error('roomId \u4e0d\u5b58\u5728');if(this.isHost){console.log('\ud83c\udfaf [LANService] \u623f\u4e3b\u5904\u7406\u6e38\u620f\u52a8\u4f5c...');const o=this.createMockIO();console.log('\ud83d\udd0d [LANService] \u83b7\u53d6\u6e38\u620f\u5b9e\u4f8b...');const n=await p.default.getGameInstance(t,o);if(console.log('\ud83d\udc1b [LANService] \u6e38\u620f\u5b9e\u4f8b:',n),console.log('\ud83d\udc1b [LANService] \u6e38\u620f\u5b9e\u4f8b\u7c7b\u578b:',n?.constructor?.name),console.log('\ud83d\udc1b [LANService] \u662f\u5426\u6709 onPlayerAction:','function'==typeof n?.onPlayerAction),!n)throw console.error('\u274c [LANService] \u6e38\u620f\u5b9e\u4f8b\u4e0d\u5b58\u5728!'),new Error('\u6e38\u620f\u4e0d\u5b58\u5728');if('function'!=typeof n.onPlayerAction)throw console.error('\u274c [LANService] \u6e38\u620f\u5b9e\u4f8b\u6ca1\u6709 onPlayerAction \u65b9\u6cd5!'),console.error('\ud83d\udc1b [LANService] \u6e38\u620f\u5bf9\u8c61\u7684\u6240\u6709\u5c5e\u6027:',Object.keys(n)),console.error('\ud83d\udc1b [LANService] \u6e38\u620f\u5bf9\u8c61\u7684\u539f\u578b:',Object.getPrototypeOf(n)),new Error('\u6e38\u620f\u5b9e\u4f8b\u65e0\u6548\uff1a\u7f3a\u5c11 onPlayerAction \u65b9\u6cd5');let s=null;const c=e=>{s=e};return console.log('\ud83c\udfaf [LANService] \u8c03\u7528 game.onPlayerAction...'),await n.onPlayerAction(o,this.currentPlayerId,e,c),console.log('\u2705 [LANService] onPlayerAction \u6267\u884c\u5b8c\u6210, \u7ed3\u679c:',s),await p.default.updateGameInstance(t,n),s}return console.log('\ud83d\udce4 [LANService] \u5ba2\u6237\u7aef\u53d1\u9001\u6e38\u620f\u52a8\u4f5c\u5230\u670d\u52a1\u5668...'),new Promise((t,o)=>{const s=setTimeout(()=>{o(new Error('\u6e38\u620f\u52a8\u4f5c\u8d85\u65f6')),this.timers.delete(s)},1e4);this.timers.add(s),n.tcpClient.sendEvent('game:action',e,e=>{clearTimeout(s),this.timers.delete(s);const n=e;n.error?o(new Error(n.error)):t(e)})})}setupTCPServerEvents(){const e=e=>{console.log('\ud83d\udc64 \u65b0\u5ba2\u6237\u7aef\u8fde\u63a5:',e.clientId)};this.tcpServerHandlers.set('client:connected',e),o.tcpServer.on('client:connected',e);const n=async e=>{if(console.log('\ud83d\udc4b \u5ba2\u6237\u7aef\u65ad\u5f00:',e.playerId),this.currentRoom){const n=await c.default.removePlayerFromRoom(this.currentRoom.id,e.playerId);n&&(this.currentRoom=n,o.tcpServer.broadcast({type:'broadcast',event:'room:update',data:n}),t.udpBroadcastService.updateRoomInfo({currentPlayers:n.players.length}),this.emit('room:update',n))}};this.tcpServerHandlers.set('client:disconnected',n),o.tcpServer.on('client:disconnected',n),console.log('\ud83d\udc1b [DEBUG] \u68c0\u67e5 room:join \u4e8b\u4ef6\u76d1\u542c\u5668\u662f\u5426\u5b58\u5728');const s=async e=>{try{if(console.log('\ud83d\udce8 [TCPServer] \u6536\u5230 room:join \u8bf7\u6c42'),console.log('\ud83d\udccb [TCPServer] \u8bf7\u6c42\u6570\u636e:',JSON.stringify({playerId:e.playerId,requestId:e.requestId,playerName:e.data?.playerName})),!this.currentRoom)throw console.error('\u274c [TCPServer] \u623f\u95f4\u4e0d\u5b58\u5728'),new Error('\u623f\u95f4\u4e0d\u5b58\u5728');console.log('\u2705 [TCPServer] \u5f53\u524d\u623f\u95f4:',this.currentRoom.id);let n=await l.default.getPlayer(e.playerId);n?(console.log('\ud83d\udd04 [TCPServer] \u66f4\u65b0\u73b0\u6709\u73a9\u5bb6:',e.playerId),n.name=e.data.playerName||n.name,n.isHost=!1,n.avatarId=e.data.avatarId||'',n.gender=e.data.gender||'man',n.color||(n.color=this.getRandomColor()),await l.default.updatePlayer(n),console.log('\u2705 [TCPServer] \u73a9\u5bb6\u66f4\u65b0\u6210\u529f')):(console.log('[TCPServer] \u521b\u5efa\u65b0\u73a9\u5bb6:',e.playerId),n=await l.default.addPlayer(e.playerId,{playerId:e.playerId,name:e.data.playerName||`Player_${e.playerId.substring(0,6)}`,roomId:this.currentRoom.id,isHost:!1,socketId:e.playerId,isConnected:!0,avatarId:e.data.avatarId||'',gender:e.data.gender||'man',color:this.getRandomColor()}),console.log('\u2705 [TCPServer] \u73a9\u5bb6\u521b\u5efa\u6210\u529f')),console.log('\ud83d\udeaa [TCPServer] \u5c06\u73a9\u5bb6\u52a0\u5165\u623f\u95f4...');const s=await c.default.addPlayerToRoom(this.currentRoom.id,n);if(!s)throw console.error('\u274c [TCPServer] \u623f\u95f4\u5df2\u6ee1'),new Error('\u623f\u95f4\u5df2\u6ee1');console.log('\u2705 [TCPServer] \u73a9\u5bb6\u5df2\u52a0\u5165\u623f\u95f4\uff0c\u5f53\u524d\u73a9\u5bb6\u6570:',s.players.length),n.roomId=s.id,await l.default.updatePlayer(n),this.currentRoom=s,console.log('\ud83d\udce4 [TCPServer] \u53d1\u9001\u54cd\u5e94\u5230\u5ba2\u6237\u7aef:',e.playerId),console.log('\ud83d\udccb [TCPServer] \u54cd\u5e94\u6570\u636e: requestId=',e.requestId,', roomId=',s.id);const p=o.tcpServer.sendToClient(e.playerId,{type:'response',requestId:e.requestId,data:s});console.log(p?'\u2705 [TCPServer] \u54cd\u5e94\u53d1\u9001\u6210\u529f':'\u274c [TCPServer] \u54cd\u5e94\u53d1\u9001\u5931\u8d25'),console.log('\ud83d\udce1 [TCPServer] \u5e7f\u64ad\u623f\u95f4\u66f4\u65b0...'),console.log('\ud83d\udc1b [DEBUG] \u5f53\u524d\u8fde\u63a5\u7684\u5ba2\u6237\u7aef\u6570:',o.tcpServer.getClientCount()),o.tcpServer.broadcast({type:'broadcast',event:'room:update',data:s}),console.log('\ud83d\udc1b [DEBUG] \u5e7f\u64ad\u5df2\u53d1\u9001'),t.udpBroadcastService.updateRoomInfo({currentPlayers:s.players.length}),console.log('\ud83d\udc1b [DEBUG] \u51c6\u5907\u89e6\u53d1 room:update \u4e8b\u4ef6'),console.log('\ud83d\udc1b [DEBUG] \u76d1\u542c\u5668\u6570\u91cf:',this.eventListeners.get('room:update')?.size||0),console.log('\ud83d\udc1b [DEBUG] \u66f4\u65b0\u540e\u7684\u623f\u95f4\u73a9\u5bb6\u6570:',s.players.length),console.log('\ud83d\udc1b [DEBUG] \u73a9\u5bb6\u5217\u8868:',s.players.map(e=>e.name).join(', ')),this.emit('room:update',s),console.log('\ud83d\udc1b [DEBUG] room:update \u4e8b\u4ef6\u5df2\u89e6\u53d1')}catch(t){const n=t?.message||'Unknown error';console.error('\u274c [TCPServer] \u52a0\u5165\u623f\u95f4\u5931\u8d25:',n),console.log('\ud83d\udce4 [TCPServer] \u53d1\u9001\u9519\u8bef\u54cd\u5e94\u5230\u5ba2\u6237\u7aef:',e.playerId),o.tcpServer.sendToClient(e.playerId,{type:'response',requestId:e.requestId,data:{error:n}})}};this.tcpServerHandlers.set('room:join',s),o.tcpServer.on('room:join',s);const p=async e=>{try{const t=await this.handleGameAction(e.data);o.tcpServer.sendToClient(e.playerId,{type:'response',requestId:e.requestId,data:t})}catch(t){const n=t?.message||'Unknown error';o.tcpServer.sendToClient(e.playerId,{type:'response',requestId:e.requestId,data:{error:n}})}};this.tcpServerHandlers.set('game:action',p),o.tcpServer.on('game:action',p)}setupTCPClientEvents(){const e=()=>{console.log('\u2705 TCP \u8fde\u63a5\u6210\u529f'),this.emit('connected',{})};this.tcpClientHandlers.set('connected',e),n.tcpClient.on('connected',e);const t=()=>{console.log('\ud83d\udc4b TCP \u8fde\u63a5\u65ad\u5f00'),this.emit('disconnected',{})};this.tcpClientHandlers.set('disconnected',t),n.tcpClient.on('disconnected',t);const o=e=>{console.log('\ud83d\udce8 \u6536\u5230\u623f\u95f4\u66f4\u65b0:',e),this.currentRoom=e,this.emit('room:update',e)};this.tcpClientHandlers.set('room:update',o),n.tcpClient.on('room:update',o);const s=e=>{this.emit('game:started',e)};this.tcpClientHandlers.set('game:started',s),n.tcpClient.on('game:started',s);const c=e=>{this.emit('game:stateUpdate',e)};this.tcpClientHandlers.set('game:stateUpdate',c),n.tcpClient.on('game:stateUpdate',c);const l=e=>{this.emit('game:ended',e)};this.tcpClientHandlers.set('game:ended',l),n.tcpClient.on('game:ended',l)}createMockIO(){return{to:e=>({emit:(t,n)=>{console.log(`\ud83d\udce1 [MockIO] to(${e}).emit(${t})`),console.log("\ud83d\udce4 [MockIO] \u5e7f\u64ad\u5230\u6240\u6709\u5ba2\u6237\u7aef..."),o.tcpServer.broadcast({type:'broadcast',event:t,data:n}),console.log(`\ud83d\udd14 [MockIO] \u89e6\u53d1\u672c\u5730\u4e8b\u4ef6: ${t}`),this.emit(t,n),console.log("\u2705 [MockIO] \u672c\u5730\u4e8b\u4ef6\u89e6\u53d1\u5b8c\u6210")}}),emit:(e,t)=>{console.log(`\ud83d\udce1 [MockIO] emit(${e})`),o.tcpServer.broadcast({type:'broadcast',event:e,data:t}),this.emit(e,t)}}}on(e,t){console.log(`\ud83d\udc1b [LANService] \u6ce8\u518c\u4e8b\u4ef6\u76d1\u542c\u5668: ${e}`),this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t),console.log(`\ud83d\udc1b [LANService] ${e} \u76d1\u542c\u5668\u6570\u91cf:`,this.eventListeners.get(e).size)}off(e,t){const o=this.eventListeners.get(e);o&&o.delete(t)}emit(e,t){console.log(`\ud83d\udd14 [LANService] emit \u4e8b\u4ef6: ${e}`),console.log(`\ud83d\udc1b [LANService] \u76d1\u542c\u5668\u6570\u91cf: ${this.eventListeners.get(e)?.size||0}`);const o=this.eventListeners.get(e);o?(console.log(`\ud83d\udce2 [LANService] \u5f00\u59cb\u89e6\u53d1 ${e} \u4e8b\u4ef6\uff0c\u76d1\u542c\u5668\u6570\u91cf: ${o.size}`),o.forEach(o=>{try{o(t),console.log(`\u2705 [LANService] ${e} \u76d1\u542c\u5668\u6267\u884c\u6210\u529f`)}catch(t){console.error(`\u4e8b\u4ef6\u5904\u7406\u5668\u9519\u8bef [${e}]:`,t)}})):console.warn(`\u26a0\ufe0f [LANService] \u6ca1\u6709\u627e\u5230 ${e} \u7684\u76d1\u542c\u5668`)}getCurrentRoom(){return this.currentRoom}getStatus(){return{isHost:this.isHost,localIP:this.localIP,currentRoom:this.currentRoom,tcpServerStatus:this.isHost?o.tcpServer.getStatus():null,tcpClientStatus:this.isHost?null:n.tcpClient.getStatus()}}async cleanup(){console.log('\ud83e\uddf9 \u6e05\u7406 LAN \u670d\u52a1...'),this.clearAllTimers(),this.isHost&&(console.log(`\ud83e\uddf9 \u79fb\u9664 ${this.tcpServerHandlers.size} \u4e2a TCP Server \u4e8b\u4ef6\u76d1\u542c\u5668`),this.tcpServerHandlers.forEach((e,t)=>{o.tcpServer.off(t,e)}),this.tcpServerHandlers.clear()),this.isHost||(console.log(`\ud83e\uddf9 \u79fb\u9664 ${this.tcpClientHandlers.size} \u4e2a TCP Client \u4e8b\u4ef6\u76d1\u542c\u5668`),this.tcpClientHandlers.forEach((e,t)=>{n.tcpClient.off(t,e)}),this.tcpClientHandlers.clear()),t.udpBroadcastService.cleanup(),await o.tcpServer.stop(),n.tcpClient.disconnect(),this.currentRoom&&(await p.default.removeGameInstance(this.currentRoom.id),await c.default.deleteRoom(this.currentRoom.id)),await l.default.cleanup(),this.currentRoom=null,this.isHost=!1,console.log('\u2705 LAN \u670d\u52a1\u6e05\u7406\u5b8c\u6210')}getRandomColor(){const e=['#FF6B6B','#4ECDC4','#45B7D1','#FFA07A','#98D8C8','#F7DC6F'];return e[Math.floor(Math.random()*e.length)]}}const h=u.getInstance()},1210,[1205,1208,1209,1094,1211,1212,1213]);
__d(function(g,r,i,a,m,e,d){"use strict";Object.defineProperty(e,'__esModule',{value:!0}),Object.defineProperty(e,"default",{enumerable:!0,get:function(){return t}});var t=new class{rooms=new Map;async createRoom({name:t,hostId:o,maxPlayers:s=4,gameType:n,taskSet:l=null,...y}){const c=Math.random().toString(36).substring(2,8).toUpperCase(),h={id:c,name:t,hostId:o,players:[],maxPlayers:s,gameStatus:'waiting',gameType:n,createdAt:Date.now(),lastActivity:Date.now(),engine:null,currentUser:void 0,boardPath:void 0,taskSet:l||void 0,tasks:l?.tasks||[],gameState:{playerPositions:{},turnCount:0,gamePhase:'waiting',startTime:Date.now(),boardSize:0},...y};return this.rooms.set(c,h),console.log(`Room created: ${c}`,{name:t,gameType:n,taskSetId:l?.id,tasksCount:l?.tasks?.length||0}),h}async deleteRoom(t){this.rooms.delete(t),console.log(`Room deleted: ${t}`)}async updateRoom(t){t.lastActivity=Date.now(),this.rooms.set(t.id,t)}async getRoom(t){return this.rooms.get(t)||null}async addPlayerToRoom(t,o){const s=this.rooms.get(t);if(!s)return null;if(s.players.length>=s.maxPlayers)throw new Error('\u623f\u95f4\u5df2\u6ee1');return o.roomId=t,o.position=0,o.score=0,s.gameState||(s.gameState={playerPositions:{},turnCount:0,gamePhase:'waiting',startTime:Date.now(),boardSize:s.boardPath?.length||0}),s.gameState.playerPositions[o.id]=0,s.players.push(o),s.lastActivity=Date.now(),this.rooms.set(t,s),console.log(`Player ${o.id} added to room ${t}`,{playersCount:s.players.length,maxPlayers:s.maxPlayers}),s}async removePlayerFromRoom(t,o){const s=this.rooms.get(t);return s?(s.players=s.players.filter(t=>t.playerId!==o&&t.id!==o),s.gameState?.playerPositions&&delete s.gameState.playerPositions[o],s.hostId===o&&s.players.length>0&&(s.hostId=s.players[0]?.playerId||s.players[0]?.id||'',s.players.forEach(t=>t.isHost=!1),s.players[0].isHost=!0,console.log(`Host transferred to ${s.hostId}`)),0===s.players.length?(console.log('Room is empty, deleting'),this.rooms.delete(t),null):(s.lastActivity=Date.now(),this.rooms.set(t,s),console.log(`Player ${o} removed from room ${t}`,{playersLeft:s.players.length}),s)):null}async getAllRooms(){const t={};return this.rooms.forEach((o,s)=>{t[s]=o}),t}async touchRoom(t){const o=this.rooms.get(t);o&&(o.lastActivity=Date.now(),this.rooms.set(t,o))}async cleanupInactiveRooms(t=18e5){const o=Date.now();for(const[s,n]of this.rooms.entries())o-n.lastActivity>t&&(this.rooms.delete(s),console.log(`Cleaned up inactive room: ${s}`))}async cleanup(){this.rooms.clear(),console.log('All rooms cleared')}}},1211,[]);
__d(function(g,r,i,a,m,e,d){"use strict";Object.defineProperty(e,'__esModule',{value:!0}),Object.defineProperty(e,"default",{enumerable:!0,get:function(){return t}});var t=new class{players=new Map;async addPlayer(t,l){const s=Date.now(),n={...l,id:t,playerId:t,socketId:l.socketId||t,isConnected:l.isConnected??!0,position:l.position??0,score:l.score??0,color:l.color||this.getDefaultColor(),completedTasks:[],achievements:[],joinedAt:s,lastSeen:s,lastActivity:s,avatarId:l.avatarId||'',gender:l.gender||'man'};return this.players.set(t,n),console.log(`Player added: ${t}`,n),n}async getPlayer(t){return this.players.get(t)||null}async updatePlayer(t){t.lastSeen=Date.now(),t.lastActivity=Date.now(),this.players.set(t.id,t)}async deletePlayer(t){this.players.delete(t),console.log(`Player deleted: ${t}`)}async getAllPlayers(){return Array.from(this.players.values())}async cleanupInactivePlayers(t=18e5){const l=Date.now();for(const[s,n]of this.players.entries())l-(n.lastActivity||n.lastSeen||0)>t&&(this.players.delete(s),console.log(`Cleaned up inactive player: ${s}`))}getDefaultColor(){const t=['#FF6B6B','#4ECDC4','#45B7D1','#FFA07A','#98D8C8','#F7DC6F'];return t[Math.floor(Math.random()*t.length)]}async cleanup(){this.players.clear(),console.log('All players cleared')}}},1212,[]);
__d(function(g,r,i,a,m,_e,d){"use strict";function e(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(_e,'__esModule',{value:!0}),Object.defineProperty(_e,"default",{enumerable:!0,get:function(){return c}});var n=e(r(d[0])),o=e(r(d[1]));const t=new class{games=new Map;registerGame(e,n){this.games.set(e,n),console.log(`\u2705 \u6e38\u620f\u7c7b\u578b\u5df2\u6ce8\u518c: ${e}`)}createGame(e,n,o){console.log('\ud83c\udfae [GameRegistry] createGame \u8c03\u7528, type:',e);const t=this.games.get(e);if(!t)return console.error(`\u274c \u6e38\u620f\u7c7b\u578b\u672a\u6ce8\u518c: ${e}`),console.error('\ud83d\udc1b [GameRegistry] \u5df2\u6ce8\u518c\u7684\u6e38\u620f\u7c7b\u578b:',Array.from(this.games.keys())),null;console.log('\u2705 [GameRegistry] \u627e\u5230\u6e38\u620f\u7c7b:',t.name),console.log('\ud83c\udfd7\ufe0f [GameRegistry] \u521b\u5efa\u6e38\u620f\u5b9e\u4f8b...');try{const e=new t(n,o);return console.log('\u2705 [GameRegistry] \u6e38\u620f\u5b9e\u4f8b\u521b\u5efa\u6210\u529f'),console.log('\ud83d\udc1b [GameRegistry] \u5b9e\u4f8b\u7c7b\u578b:',e?.constructor?.name),console.log('\ud83d\udc1b [GameRegistry] \u5b9e\u4f8b\u6709 onPlayerAction:','function'==typeof e?.onPlayerAction),e}catch(e){return console.error('\u274c [GameRegistry] \u521b\u5efa\u6e38\u620f\u5b9e\u4f8b\u5931\u8d25:',e),null}}};t.registerGame('fly',o.default);var c=new class{games=new Map;localCache=new Map;GAME_TTL=72e5;async createGameInstance(e,n){console.log('\ud83c\udfd7\ufe0f [GameInstanceManager] createGameInstance \u8c03\u7528'),console.log('\ud83d\udc1b [GameInstanceManager] room.id:',e.id),console.log('\ud83d\udc1b [GameInstanceManager] room.gameType:',e.gameType);const o=t.createGame(e.gameType,e,n);if(!o)throw console.error(`\u274c \u4e0d\u652f\u6301\u7684\u6e38\u620f\u7c7b\u578b: ${e.gameType}`),new Error(`\u4e0d\u652f\u6301\u7684\u6e38\u620f\u7c7b\u578b: ${e.gameType}`);return console.log('\u2705 [GameInstanceManager] \u6e38\u620f\u5b9e\u4f8b\u521b\u5efa\u6210\u529f'),console.log('\ud83d\udc1b [GameInstanceManager] \u6e38\u620f\u7c7b\u578b:',o?.constructor?.name),console.log('\ud83d\udc1b [GameInstanceManager] \u6e38\u620f\u6709 onPlayerAction:','function'==typeof o?.onPlayerAction),this.games.set(e.id,{roomId:e.id,gameType:e.gameType,createdAt:Date.now(),lastActivity:Date.now()}),this.localCache.set(e.id,o),console.log('\ud83d\udcbe [GameInstanceManager] \u6e38\u620f\u5b9e\u4f8b\u5df2\u7f13\u5b58\u5230 localCache'),console.log(`\ud83c\udfae \u6e38\u620f\u5b9e\u4f8b\u5df2\u521b\u5efa: \u623f\u95f4=${e.id}, \u7c7b\u578b=${e.gameType}`),o}async getGameInstance(e,o){if(console.log('\ud83d\udd0d [GameInstanceManager] getGameInstance \u8c03\u7528, roomId:',e),this.localCache.has(e)){const n=this.localCache.get(e);return console.log('\u2705 [GameInstanceManager] \u4ece\u7f13\u5b58\u83b7\u53d6\u6e38\u620f\u5b9e\u4f8b'),console.log('\ud83d\udc1b [GameInstanceManager] \u7f13\u5b58\u7684\u6e38\u620f\u7c7b\u578b:',n?.constructor?.name),console.log('\ud83d\udc1b [GameInstanceManager] \u7f13\u5b58\u7684\u6e38\u620f\u6709 onPlayerAction:','function'==typeof n?.onPlayerAction),n??null}console.log('\u26a0\ufe0f [GameInstanceManager] \u7f13\u5b58\u4e2d\u6ca1\u6709\u6e38\u620f\u5b9e\u4f8b\uff0c\u5c1d\u8bd5\u91cd\u5efa...');const t=this.games.get(e);if(!t)return console.error('\u274c [GameInstanceManager] \u6e38\u620f\u6570\u636e\u4e0d\u5b58\u5728'),null;console.log('\u2705 [GameInstanceManager] \u627e\u5230\u6e38\u620f\u6570\u636e:',t);const c=await n.default.getRoom(e);if(!c)return console.error('\u274c [GameInstanceManager] \u623f\u95f4\u4e0d\u5b58\u5728\uff0c\u5220\u9664\u6e38\u620f\u6570\u636e'),this.games.delete(e),null;console.log('\u2705 [GameInstanceManager] \u627e\u5230\u623f\u95f4\u6570\u636e, gameType:',c.gameType),console.log('\ud83d\udd04 [GameInstanceManager] \u5f00\u59cb\u91cd\u5efa\u6e38\u620f\u5b9e\u4f8b...');const s=this.recreateGameInstance(c,o);return s?(console.log('\u2705 [GameInstanceManager] \u6e38\u620f\u5b9e\u4f8b\u91cd\u5efa\u6210\u529f'),console.log('\ud83d\udc1b [GameInstanceManager] \u91cd\u5efa\u7684\u6e38\u620f\u7c7b\u578b:',s?.constructor?.name),console.log('\ud83d\udc1b [GameInstanceManager] \u91cd\u5efa\u7684\u6e38\u620f\u6709 onPlayerAction:','function'==typeof s?.onPlayerAction),this.localCache.set(e,s),console.log('\ud83d\udcbe [GameInstanceManager] \u6e38\u620f\u5b9e\u4f8b\u5df2\u7f13\u5b58')):console.error('\u274c [GameInstanceManager] \u6e38\u620f\u5b9e\u4f8b\u91cd\u5efa\u5931\u8d25'),s}async updateGameInstance(e,n){this.games.has(e)&&(this.games.get(e).lastActivity=Date.now())}async removeGameInstance(e){this.games.delete(e),this.localCache.delete(e),console.log(`Game instance removed for room: ${e}`)}async getAllActiveGames(){const e={};return this.games.forEach((n,o)=>{e[o]=n}),e}async cleanupExpiredGames(){const e=Date.now();for(const[n,o]of this.games.entries())e-o.lastActivity>this.GAME_TTL&&(await this.removeGameInstance(n),console.log(`Cleaned up expired game: ${n}`))}recreateGameInstance(e,n){if(console.log('\ud83d\udd04 [GameInstanceManager] recreateGameInstance \u8c03\u7528'),console.log('\ud83d\udc1b [GameInstanceManager] room.gameType:',e.gameType),console.log('\ud83d\udc1b [GameInstanceManager] io \u662f\u5426\u5b58\u5728:',!!n),!n)return console.warn('\u26a0\ufe0f \u65e0\u6cd5\u91cd\u5efa\u6e38\u620f\u5b9e\u4f8b: \u7f3a\u5c11 io \u53c2\u6570'),null;console.log('\ud83c\udfae [GameInstanceManager] \u8c03\u7528 gameRegistry.createGame...');const o=t.createGame(e.gameType,e,n);return o?(console.log(`\u2705 \u6e38\u620f\u5b9e\u4f8b\u5df2\u91cd\u5efa: \u623f\u95f4=${e.id}, \u7c7b\u578b=${e.gameType}`),console.log('\ud83d\udc1b [GameInstanceManager] \u91cd\u5efa\u540e\u6e38\u620f\u7c7b\u578b:',o?.constructor?.name),console.log('\ud83d\udc1b [GameInstanceManager] \u91cd\u5efa\u540e\u6e38\u620f\u6709 onPlayerAction:','function'==typeof o?.onPlayerAction)):console.error('\u274c [GameInstanceManager] gameRegistry.createGame \u8fd4\u56de null'),o}clearLocalCache(){this.localCache.clear()}getCacheStats(){return{localCacheSize:this.localCache.size,gamesCount:this.games.size}}registerGame(e,n){t.registerGame(e,n)}async cleanup(){this.games.clear(),this.localCache.clear(),console.log('All games cleared')}}},1213,[1211,1214]);
__d(function(g,r,i,a,m,_e,d){"use strict";Object.defineProperty(_e,'__esModule',{value:!0}),Object.defineProperty(_e,"default",{enumerable:!0,get:function(){return l}});var t,e=r(d[0]),o=(t=e)&&t.__esModule?t:{default:t},s=r(d[1]);class n extends o.default{constructor(t,e){super(t,e),console.log('\ud83c\udfae \u98de\u884c\u68cb\u6e38\u620f\u5b9e\u4f8b\u521b\u5efa')}async onStart(){if(console.log('\ud83d\ude80 \u5f00\u59cb\u98de\u884c\u68cb\u6e38\u620f'),this.gamePhase='playing',this.room.gameStatus='playing',console.log('\u2705 gameStatus \u5df2\u8bbe\u7f6e\u4e3a playing'),this.room.tasks=this.room.taskSet?.tasks||[],console.log('\ud83d\udccb \u4efb\u52a1\u96c6\u68c0\u67e5:',{taskSetExists:!!this.room.taskSet,taskSetId:this.room.taskSet?.id,taskSetName:this.room.taskSet?.name,tasksCount:this.room.tasks?.length}),!this.room.boardPath){console.log('\ud83d\udccb \u521d\u59cb\u5316\u98de\u884c\u68cb\u68cb\u76d8\u8def\u5f84');const t=(0,s.createBoardPath)();this.room.boardPath=t;const e=t.filter(t=>'path'!==t.type&&'start'!==t.type&&'end'!==t.type);console.log(`\ud83c\udfaf \u68cb\u76d8\u7279\u6b8a\u683c\u5b50\u6570\u91cf: \u661f\u661f=${e.filter(t=>'star'===t.type).length}, \u9677\u9631=${e.filter(t=>'trap'===t.type).length}`),this.room.gameState&&(this.room.gameState.boardSize=t.length)}this.room.players.forEach(t=>{t.position=0}),this.room.currentUser=this.room.players[0]?.id||this.room.hostId,this.syncGameState(),console.log('\u2705 \u6e38\u620f\u5f00\u59cb\uff0c\u521d\u59cb\u72b6\u6001:',{gameStatus:this.room.gameStatus,currentUser:this.room.currentUser,playersCount:this.room.players.length,playerPositions:this.playerPositions}),console.log('\ud83d\udce4 \u51c6\u5907\u8c03\u7528 updateRoomAndNotify...'),await this.updateRoomAndNotify(),console.log('\u2705 updateRoomAndNotify \u5b8c\u6210')}async onResume(){console.log('\ud83d\udd04 \u7ee7\u7eed\u98de\u884c\u68cb\u6e38\u620f'),this.room.boardPath||(console.log('\ud83d\udccb \u91cd\u65b0\u521b\u5efa\u68cb\u76d8\u8def\u5f84'),this.room.boardPath=(0,s.createBoardPath)(),this.room.gameState&&(this.room.gameState.boardSize=this.room.boardPath.length)),this.syncGameState(),console.log('\u2705 \u6e38\u620f\u7ee7\u7eed\uff0c\u5f53\u524d\u72b6\u6001:',{gameStatus:this.room.gameStatus,currentUser:this.room.currentUser,playersCount:this.room.players.length,boardPathLength:this.room.boardPath?.length,playerPositions:this.playerPositions}),await this.updateRoomAndNotify()}async onPlayerAction(t,e,o,s){if(console.log('\ud83c\udfaf [FlightChessGame] onPlayerAction \u88ab\u8c03\u7528!'),console.log('\ud83d\udc1b [FlightChessGame] playerId:',e),console.log('\ud83d\udc1b [FlightChessGame] action:',JSON.stringify(o)),console.log('\ud83d\udc1b [FlightChessGame] \u5f53\u524d\u6e38\u620f\u72b6\u6001:',this.room.gameStatus),console.log('\ud83d\udc1b [FlightChessGame] \u56de\u8c03\u51fd\u6570\u5b58\u5728:','function'==typeof s),'playing'!==this.room.gameStatus)return console.warn('\u26a0\ufe0f [FlightChessGame] \u6e38\u620f\u672a\u5728\u8fdb\u884c\u4e2d\uff0c\u62d2\u7edd\u64cd\u4f5c'),void s?.({success:!1,error:'\u6e38\u620f\u672a\u5728\u8fdb\u884c\u4e2d'});const n=o;switch(console.log('\ud83c\udfae [FlightChessGame] \u5904\u7406\u6e38\u620f\u52a8\u4f5c, type:',n.type),n.type){case'roll_dice':console.log('\ud83c\udfb2 [FlightChessGame] \u5904\u7406\u6295\u9ab0\u5b50\u52a8\u4f5c'),await this._handleDiceRoll(e,s);break;case'move_complete':console.log('\ud83d\udeb6 [FlightChessGame] \u5904\u7406\u79fb\u52a8\u5b8c\u6210\u52a8\u4f5c'),await this._handleMoveComplete(e),s?.({success:!0});break;case'complete_task':console.log('\ud83d\udccb [FlightChessGame] \u5904\u7406\u4efb\u52a1\u5b8c\u6210\u52a8\u4f5c'),await this._handleTaskComplete(e,n),s?.({success:!0});break;default:console.warn('\u26a0\ufe0f [FlightChessGame] \u672a\u77e5\u7684\u52a8\u4f5c\u7c7b\u578b:',n.type)}console.log('\u2705 [FlightChessGame] onPlayerAction \u6267\u884c\u5b8c\u6210')}async _handleDiceRoll(t,e){const o=this.room.players.find(t=>t.id===this.room.currentUser);if(console.log(`\ud83c\udfb2 \u6295\u9ab0\u5b50\u8bf7\u6c42: playerId=${t}, currentUser=${this.room.currentUser}, currentPlayer=${o?.name}`),!o||o.id!==t)return console.log("\u274c \u6295\u9ab0\u5b50\u88ab\u62d2\u7edd: \u4e0d\u662f\u5f53\u524d\u73a9\u5bb6\u7684\u56de\u5408"),void e?.({success:!1,error:'\u4e0d\u662f\u5f53\u524d\u73a9\u5bb6\u7684\u56de\u5408'});const s=Math.floor(6*Math.random())+1;console.log(`\ud83c\udfb2 \u9ab0\u5b50\u7ed3\u679c: ${s}, \u73a9\u5bb6: ${o.name} (${t})`),this.room.gameState&&(this.room.gameState.lastDiceRoll={playerId:t,playerName:o.name,diceValue:s,timestamp:Date.now()}),e?.({playerId:t,diceValue:s,success:!0,timestamp:Date.now(),playerName:o.name}),this.socket.to(this.room.id).emit('game:dice',{playerId:t,diceValue:s,success:!0,timestamp:Date.now(),playerName:o.name})}_checkCollision(t,e){for(const[o,s]of Object.entries(this.playerPositions))if(o!==t&&s===e)return!0;return!1}_getCellType(t){const e=this.room.boardPath?.find(e=>e.id===t),o=e?e.type:'path';return console.log(`\ud83d\udd0d \u683c\u5b50\u7c7b\u578b\u68c0\u67e5: \u4f4d\u7f6e${t}, \u627e\u5230\u683c\u5b50=${!!e}, \u7c7b\u578b=${o}`),e&&console.log("\ud83d\udccd \u683c\u5b50\u8be6\u60c5:",{position:e.id,type:e.type,x:e.x,y:e.y}),o}async _triggerTask(t,e="star"){const o=this.room.taskSet;if(console.log(`\ud83c\udfaf \u5f00\u59cb\u89e6\u53d1\u4efb\u52a1: \u73a9\u5bb6=${t}, \u7c7b\u578b=${e}`),!o||!o.tasks||0===o.tasks.length)return console.log("\u274c \u6ca1\u6709\u53ef\u7528\u7684\u4efb\u52a1\u96c6\uff0c\u8df3\u8fc7\u4efb\u52a1\u89e6\u53d1"),void await this._nextPlayer();let s=[];if('star'===e||'collision'===e)s=this.room.players.filter(e=>e.id!==t);else{const e=this.room.players.find(e=>e.id===t);e&&(s=[e])}if(0===s.length)return console.log("\u274c \u6ca1\u6709\u6267\u884c\u8005\uff0c\u8df3\u8fc7\u4efb\u52a1\u89e6\u53d1"),void await this._nextPlayer();const n=[];let l=[...this.room.tasks||[]];const c=o.tasks||[];console.log(`\ud83d\udccb \u4efb\u52a1\u5206\u914d: \u6267\u884c\u8005\u6570\u91cf=${s.length}, \u53ef\u7528\u4efb\u52a1\u6c60=${l.length}, \u4efb\u52a1\u96c6\u603b\u6570=${c.length}`);for(const t of s){let e;if(l.length>0){const o=Math.floor(Math.random()*l.length);e=l[o],l.splice(o,1),console.log(`\ud83c\udfb2 \u4ece\u4efb\u52a1\u6c60\u5206\u914d\u4efb\u52a1\u7ed9 ${t.name}: ${e}`)}else{e=c[Math.floor(Math.random()*c.length)],console.log(`\ud83d\udd04 \u4efb\u52a1\u6c60\u4e3a\u7a7a\uff0c\u4ece\u4efb\u52a1\u96c6\u968f\u673a\u62bd\u53d6\u7ed9 ${t.name}: ${e}`)}const s={id:t.id,name:t.name||'',color:t.color||'#FF6B6B',position:t.position||0,score:t.score||0,avatarId:t.avatarId||'',gender:t.gender||'man',isAI:t.isAI||!1,completedTasks:t.completedTasks||[],achievements:t.achievements||[]};n.push({executor:s,task:{title:e,...o.description?{description:o.description}:{}},completed:!1})}this.room.tasks=l;const h={id:o.id,type:e,category:o.categoryName||'default',difficulty:o.difficulty||'medium',triggerPlayerIds:[t],executorTasks:n};this.room.gameState&&(this.room.gameState.currentTask=h,this.room.gameState.hasPendingTask=!0),console.log(`\ud83d\udce4 \u53d1\u9001\u4efb\u52a1\u4e8b\u4ef6\u5230\u623f\u95f4 ${this.room.id}:`,{taskType:e,executorCount:n.length,executorPlayerIds:s.map(t=>t.id),triggerPlayerIds:[t]}),this.socket.to(this.room.id).emit('game:task',{task:h,taskType:e,executorPlayerIds:s.map(t=>t.id),triggerPlayerIds:[t]}),await this.updateRoomAndNotify(),console.log("\u23f8\ufe0f \u4efb\u52a1\u5df2\u89e6\u53d1\uff0c\u7b49\u5f85\u6240\u6709\u6267\u884c\u8005\u5b8c\u6210\u4efb\u52a1...")}async _handleMoveComplete(t){console.log(`\ud83c\udfac \u5904\u7406\u79fb\u52a8\u5b8c\u6210\u4e8b\u4ef6: \u73a9\u5bb6=${t}`);const e=this.room.gameState?.lastDiceRoll;if(!e||e.playerId!==t)return void console.log("\u274c \u65e0\u6548\u7684\u79fb\u52a8\u5b8c\u6210\u4e8b\u4ef6: \u6ca1\u6709\u5bf9\u5e94\u7684\u9ab0\u5b50\u8bb0\u5f55");const o=this.playerPositions[t]||0,s=e.diceValue,n=(this.room.gameState?.boardSize||0)-1;let l;if(o+s>n){l=n-(o+s-n)}else l=o+s;l=Math.max(0,l),this.updatePlayerPosition(t,l),console.log(`\ud83d\udccd \u73a9\u5bb6\u79fb\u52a8: ${t} \u4ece ${o} \u79fb\u52a8\u5230 ${l} (\u6b65\u6570: ${s})`),await this.updateRoomAndNotify(),await this._checkWinCondition();const c=this._checkCollision(t,l),h=this._getCellType(l);console.log(`\ud83c\udfaf \u4f4d\u7f6e\u68c0\u67e5: \u73a9\u5bb6${t} \u5230\u8fbe\u4f4d\u7f6e${l}, \u683c\u5b50\u7c7b\u578b: ${h}, \u662f\u5426\u78b0\u649e: ${c}`),c?(console.log("\ud83d\udca5 \u89e6\u53d1\u78b0\u649e\u4efb\u52a1\uff0c\u7b49\u5f85\u4efb\u52a1\u5b8c\u6210\u540e\u5207\u6362\u73a9\u5bb6"),await this._triggerTask(t,'collision')):'trap'===h?(console.log("\ud83d\udd73\ufe0f \u89e6\u53d1\u9677\u9631\u4efb\u52a1\uff0c\u7b49\u5f85\u4efb\u52a1\u5b8c\u6210\u540e\u5207\u6362\u73a9\u5bb6"),await this._triggerTask(t,'trap')):'star'===h?(console.log("\u2b50 \u89e6\u53d1\u661f\u661f\u4efb\u52a1\uff0c\u7b49\u5f85\u4efb\u52a1\u5b8c\u6210\u540e\u5207\u6362\u73a9\u5bb6"),await this._triggerTask(t,'star')):(console.log("\u2705 \u65e0\u7279\u6b8a\u4e8b\u4ef6\u89e6\u53d1\uff0c\u76f4\u63a5\u5207\u6362\u5230\u4e0b\u4e00\u4e2a\u73a9\u5bb6"),await this._nextPlayer())}async _checkWinCondition(){for(const[t,e]of Object.entries(this.playerPositions))if(e>=(this.room.gameState?.boardSize||0)-1)return void await this._endGame(t)}async _nextPlayer(){const t=(this.room.players.findIndex(t=>t.id===this.room.currentUser)+1)%this.room.players.length;this.room.currentUser=this.room.players[t]?.id||'',this.incrementTurn(),this.socket.to(this.room.id).emit('game:next',{currentUser:this.room.currentUser,roomId:this.room.id}),await this.updateRoomAndNotify()}async _endGame(t){this.gamePhase='ended',this.room.gameStatus='ended';const e=this.room.players.find(e=>e.id===t);let o=[];if(this.room.taskSet&&this.room.taskSet.tasks&&this.room.taskSet.tasks.length>0){const t=[...this.room.taskSet.tasks].sort(()=>Math.random()-.5);o=t.slice(0,Math.min(3,t.length)),console.log(`\ud83c\udfaf \u4e3a\u80dc\u5229\u8005\u9009\u62e9\u4e86 ${o.length} \u4e2a\u4efb\u52a1:`,o)}this.room.gameState&&(this.room.gameState.winner={winnerId:t,winnerName:e?.name||'\u672a\u77e5\u73a9\u5bb6',endTime:Date.now(),finalPositions:Object.entries(this.playerPositions)}),this.socket.to(this.room.id).emit('game:victory',{winner:{id:t,name:e?.name||'\u672a\u77e5\u73a9\u5bb6',color:e?.color||'#4CAF50',tasks:o},endTime:Date.now(),finalPositions:Object.entries(this.playerPositions)}),await this.updateRoomAndNotify(),await this.onEnd(this.socket)}async _handleTaskComplete(t,e){console.log(`\ud83d\udccb \u5904\u7406\u4efb\u52a1\u5b8c\u6210: \u73a9\u5bb6=${t}, \u7ed3\u679c=${e.completed}`);const o=this.room.gameState?.currentTask;if(!o||!o.executorTasks)return void console.log("\u274c \u6ca1\u6709\u627e\u5230\u5f53\u524d\u4efb\u52a1");const s=o.executorTasks.find(e=>e.executor.id===t);if(!s)return void console.log(`\u274c \u5f53\u524d\u73a9\u5bb6\u4e0d\u662f\u6267\u884c\u8005: ${t}`);if(s.completed)return void console.log(`\u26a0\ufe0f \u8be5\u73a9\u5bb6\u5df2\u7ecf\u5b8c\u6210\u8fc7\u4efb\u52a1: ${t}`);const n=o.type,l=e.completed;console.log(`\ud83c\udfaf \u4efb\u52a1\u7c7b\u578b: ${n}, \u5b8c\u6210\u72b6\u6001: ${l}`);const c=this.room.players.find(e=>e.id===t),h=c?.name||'\u73a9\u5bb6',p=Math.floor(4*Math.random())+3;let y=l?p:-p;if(0!==y){const e=this.playerPositions[t]||0,o=(this.room.gameState?.boardSize||0)-1;let s=e+y;if(s>o){s=o-(s-o)}s=Math.max(0,s),'collision'!==n||l||(s=0),this.updatePlayerPosition(t,s),console.log(`\ud83d\udccd \u4efb\u52a1\u540e\u4f4d\u7f6e\u66f4\u65b0: ${t} \u4ece ${e} \u79fb\u52a8\u5230 ${s} (\u53d8\u5316: ${y})`)}s.completed=!0,s.result={completed:l||!1,content:'collision'!==n||l?y:0,timestamp:Date.now()},console.log(`\u2705 \u73a9\u5bb6 ${h} \u5b8c\u6210\u4efb\u52a1\uff0c\u7ed3\u679c\u5df2\u4fdd\u5b58`),this.socket.to(this.room.id).emit('game:task_completed',{playerId:t,playerName:h,taskType:n,completed:l,taskTitle:s.task.title,content:s.result.content,allCompleted:!1,currentTask:o}),await this.updateRoomAndNotify(),await this._checkWinCondition();if(o.executorTasks.every(t=>t.completed))console.log("\ud83c\udf89 \u6240\u6709\u6267\u884c\u8005\u90fd\u5df2\u5b8c\u6210\u4efb\u52a1\uff0c\u51c6\u5907\u6e05\u9664\u4efb\u52a1\u5e76\u5207\u6362\u73a9\u5bb6"),this.room.gameState&&(delete this.room.gameState.currentTask,this.room.gameState.hasPendingTask=!1),this.socket.to(this.room.id).emit('game:all_tasks_completed',{taskType:n,timestamp:Date.now()}),await this.updateRoomAndNotify(),console.log("\u2705 \u4efb\u52a1\u5904\u7406\u5b8c\u6210\uff0c\u5207\u6362\u5230\u4e0b\u4e00\u4e2a\u73a9\u5bb6"),await this._nextPlayer();else{const t=o.executorTasks.filter(t=>!t.completed).length;console.log(`\u23f3 \u8fd8\u6709 ${t} \u4e2a\u6267\u884c\u8005\u672a\u5b8c\u6210\u4efb\u52a1\uff0c\u7ee7\u7eed\u7b49\u5f85...`)}}async onEnd(t){this.gamePhase='ended',this.room.gameStatus='ended',await this.updateRoomAndNotify(),this.socket.to(this.room.id).emit('room:update',this.room)}}var l=n},1214,[1215,1216]);
__d(function(g,r,i,a,m,_e,d){"use strict";Object.defineProperty(_e,'__esModule',{value:!0}),Object.defineProperty(_e,"default",{enumerable:!0,get:function(){return s}});var o,e=r(d[0]),t=(o=e)&&o.__esModule?o:{default:o};class s{gamePhase='waiting';playerPositions={};constructor(o,e){this.room=o,this.socket=e,console.log(`\ud83c\udfae Base Game \u521d\u59cb\u5316: ${o.id}, \u7c7b\u578b: ${o.gameType}`)}syncGameState(){this.room.gameState||(this.room.gameState={playerPositions:{},turnCount:0,gamePhase:this.gamePhase,startTime:Date.now(),boardSize:this.room.boardPath?.length||0});for(const o of this.room.players){const e=this.playerPositions[o.id]??o.position??0;this.room.gameState.playerPositions[o.id]=e,o.position=e}this.room.gameState.gamePhase=this.gamePhase,console.log("\ud83d\udd04 \u6e38\u620f\u72b6\u6001\u5df2\u540c\u6b65:",{gamePhase:this.gamePhase,playerPositions:this.room.gameState.playerPositions})}updatePlayerPosition(o,e){this.playerPositions[o]=e;const t=this.room.players.find(e=>e.id===o);t&&(t.position=e),this.room.gameState&&(this.room.gameState.playerPositions[o]=e),console.log(`\ud83d\udccd \u73a9\u5bb6\u4f4d\u7f6e\u66f4\u65b0: ${o} -> ${e}`)}incrementTurn(){this.room.gameState&&(this.room.gameState.turnCount++,console.log(`\ud83d\udd04 \u56de\u5408\u6570: ${this.room.gameState.turnCount}`))}async updateRoomAndNotify(){console.log(`\ud83d\udd04 [BaseGame] updateRoomAndNotify \u5f00\u59cb, roomId: ${this.room.id}`),this.syncGameState(),console.log("\ud83d\udcbe [BaseGame] \u66f4\u65b0\u623f\u95f4\u5230\u5b58\u50a8..."),await t.default.updateRoom(this.room),console.log("\u2705 [BaseGame] \u623f\u95f4\u5df2\u66f4\u65b0\u5230\u5b58\u50a8"),console.log("\ud83d\udce1 [BaseGame] \u51c6\u5907\u53d1\u9001 room:update \u4e8b\u4ef6..."),console.log("\ud83d\udc1b [BaseGame] \u623f\u95f4\u72b6\u6001:",{id:this.room.id,gameStatus:this.room.gameStatus,playersCount:this.room.players.length}),this.socket.to(this.room.id).emit('room:update',this.room),console.log("\u2705 [BaseGame] room:update \u4e8b\u4ef6\u5df2\u53d1\u9001"),console.log(`\u2705 \u623f\u95f4\u72b6\u6001\u5df2\u66f4\u65b0\u5e76\u901a\u77e5: ${this.room.id}`)}}},1215,[1211]);