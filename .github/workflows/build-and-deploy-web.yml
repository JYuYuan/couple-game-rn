name: Build and Deploy Web

on:
  # æ–¹å¼ä¸€ï¼špush commit åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'components/**'
      - 'constants/**'
      - 'hooks/**'
      - 'i18n/**'
      - 'services/**'
      - 'store/**'
      - 'types/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/build-and-deploy-web.yml'
  # æ–¹å¼äºŒï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  build-web:
    runs-on: ubuntu-latest
    env:
      EXPO_NO_DOTENV: 1
      CI: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Show environment info
        run: ./.github/scripts/show-env-info.sh

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: ./.github/scripts/install-deps.sh

      - name: Setup Expo
        run: |
          if [ -n "${{ secrets.EXPO_TOKEN }}" ]; then
            npx expo login --non-interactive -u ${{ secrets.EXPO_USERNAME }} || true
          fi

      - name: Build Web
        run: ./.github/scripts/build-web.sh

      - name: Copy SEO files to dist
        run: |
          echo "ğŸ“‹ Copying SEO files to dist..."

          # ç¡®ä¿ dist ç›®å½•å­˜åœ¨
          if [ ! -d "dist" ]; then
            echo "âŒ Error: dist directory not found!"
            exit 1
          fi

          # å¤åˆ¶ robots.txt
          if [ -f "public/robots.txt" ]; then
            cp public/robots.txt dist/robots.txt
            echo "âœ… Copied robots.txt"
          else
            echo "âš ï¸  robots.txt not found"
          fi

          # å¤åˆ¶ sitemap.xml
          if [ -f "public/sitemap.xml" ]; then
            cp public/sitemap.xml dist/sitemap.xml
            echo "âœ… Copied sitemap.xml"
          else
            echo "âš ï¸  sitemap.xml not found"
          fi

          # å¤åˆ¶ manifest.json (å¦‚æœ Expo æ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆ)
          if [ -f "public/manifest.json" ] && [ ! -f "dist/manifest.json" ]; then
            cp public/manifest.json dist/manifest.json
            echo "âœ… Copied manifest.json"
          fi

          # å¤åˆ¶ Open Graph å›¾ç‰‡
          if [ -f "public/og-image.png" ]; then
            cp public/og-image.png dist/og-image.png
            echo "âœ… Copied og-image.png"
          fi

          if [ -f "public/twitter-card.png" ]; then
            cp public/twitter-card.png dist/twitter-card.png
            echo "âœ… Copied twitter-card.png"
          fi

          # å¤åˆ¶å…¶ä»–å›¾æ ‡
          for file in public/favicon-*.png public/apple-touch-icon.png; do
            if [ -f "$file" ]; then
              cp "$file" "dist/$(basename $file)"
              echo "âœ… Copied $(basename $file)"
            fi
          done

          # åˆ›å»º .nojekyll æ–‡ä»¶
          touch dist/.nojekyll
          echo "âœ… Created .nojekyll"

          echo "ğŸ‰ All SEO files copied successfully!"

      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/
          retention-days: 30

  push-to-pages-branch:
    needs: build-web
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: dist/

      - name: Configure git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Create or update pages branch
        run: |
          # ä¸¢å¼ƒæ‰€æœ‰æœ¬åœ°æ›´æ”¹
          git reset --hard HEAD
          git clean -fd

          # åˆ é™¤æœ¬åœ° pages åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          git branch -D pages 2>/dev/null || true

          # åˆ›å»ºå…¨æ–°çš„ orphan åˆ†æ”¯
          git checkout --orphan pages

          # æ¸…ç©ºæ‰€æœ‰å†…å®¹
          git rm -rf . 2>/dev/null || true

          # å¤åˆ¶æ„å»ºæ–‡ä»¶åˆ°åˆ†æ”¯æ ¹ç›®å½•
          cp -r dist/* .
          cp dist/.nojekyll . 2>/dev/null || true

          # å¤åˆ¶ vercel.json åˆ°æ ¹ç›®å½•
          if [ -f "vercel.json" ]; then
            cp vercel.json .
            echo "âœ… Copied vercel.json"
          else
            echo "âš ï¸  vercel.json not found"
          fi

          # æäº¤å¹¶å¼ºåˆ¶æ¨é€
          git add .
          git commit -m "chore: update pages content from main branch"
          git push -f origin pages

          echo "âœ… æˆåŠŸå¼ºåˆ¶æ¨é€åˆ° pages åˆ†æ”¯"
