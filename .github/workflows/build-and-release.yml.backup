name: Build and Release

on:
  # æ–¹å¼ä¸€ï¼špush tag æ—¶è§¦å‘
  push:
    tags:
      - 'v*'
  # æ–¹å¼äºŒï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  packages: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=2048m -Dorg.gradle.daemon=false
      EXPO_NO_DOTENV: 1
      CI: false  # ç¦ç”¨ CI æ¨¡å¼ï¼Œæ¨¡æ‹Ÿæœ¬åœ°ç¯å¢ƒ
    steps:
      # 1ï¸âƒ£ è·å–ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # å¿…é¡»å®Œæ•´æ‹‰å– tag å†å²

      # 2ï¸âƒ£ è®¾ç½® Node.js ç¯å¢ƒï¼ˆåŒ¹é…ä½ çš„æœ¬åœ°ç‰ˆæœ¬ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # ç¡®ä¿è¿™ä¸ªç‰ˆæœ¬ä¸ä½ æœ¬åœ°ä¸€è‡´

      # 3ï¸âƒ£ è®¾ç½® Java ç¯å¢ƒ
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 4ï¸âƒ£ è®¾ç½® Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0

      # 4ï¸âƒ£.5 Accept Android licenses
      - name: Accept Android licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      # 4ï¸âƒ£.6 è®¾ç½®ç¯å¢ƒå˜é‡
      - name: Setup environment variables
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "PATH=$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools" >> $GITHUB_ENV
      # 5ï¸âƒ£ æ˜¾ç¤ºæœ¬åœ°ç¯å¢ƒä¿¡æ¯ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
      - name: Show environment info for comparison
        run: |
          echo "ğŸ” è¯·å¯¹æ¯”ä»¥ä¸‹ä¿¡æ¯ä¸ä½ çš„æœ¬åœ°ç¯å¢ƒï¼š"
          echo "Node.js: $(node --version)"
          echo "NPM: $(npm --version)"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la
          echo ""
          echo "package.json å†…å®¹:"
          cat package.json
          echo ""
          echo "æ£€æŸ¥ eas.json:"
          cat eas.json || echo "eas.json ä¸å­˜åœ¨"
          echo ""
          echo "æ£€æŸ¥ app.json:"
          cat app.json || echo "app.json ä¸å­˜åœ¨"
          echo ""
          echo "æ£€æŸ¥ app.config.js:"
          cat app.config.js || echo "app.config.js ä¸å­˜åœ¨"
      # 6ï¸âƒ£ å®Œå…¨æ¸…ç†å¹¶é‡æ–°å®‰è£…ï¼ˆæ¨¡æ‹Ÿæœ¬åœ°ç¯å¢ƒï¼‰
      - name: Clean install (like local)
        run: |
          # å®Œå…¨æ¸…ç†
          rm -rf node_modules
          rm -rf .expo
          rm -rf android/build
          rm -rf ios/build
          rm -f yarn.lock
          rm -f package-lock.json
          
          # ä½¿ç”¨ yarn å®‰è£…ï¼ˆå¦‚æœä½ æœ¬åœ°ç”¨ yarnï¼‰
          npm install -g yarn
          yarn install
          
          # æˆ–è€…ä½¿ç”¨ npmï¼ˆå¦‚æœä½ æœ¬åœ°ç”¨ npmï¼‰
          # npm install
      # 7ï¸âƒ£ å®‰è£…å…¨å±€å·¥å…·ï¼ˆä½¿ç”¨ä¸æœ¬åœ°ç›¸åŒçš„ç‰ˆæœ¬ï¼‰
      - name: Install global tools
        run: |
          # å®‰è£… eas-cliï¼ˆæ£€æŸ¥ä½ æœ¬åœ°çš„ç‰ˆæœ¬ï¼‰
          npm list -g eas-cli || true
          npm install -g eas-cli@latest
          
          # å®‰è£… expo-cliï¼ˆå¦‚æœéœ€è¦ï¼‰
          npm install -g expo-cli@latest
          
          echo "å·²å®‰è£…çš„å…¨å±€åŒ…:"
          npm list -g --depth=0
      # 8ï¸âƒ£ è®¾ç½® Expoï¼ˆä½¿ç”¨æœ¬åœ°ç›¸åŒçš„æ–¹å¼ï¼‰
      - name: Setup Expo
        run: |
          # å¦‚æœä½ æœ¬åœ°éœ€è¦ç™»å½•
          if [ -n "${{ secrets.EXPO_TOKEN }}" ]; then
            npx expo login --non-interactive -u ${{ secrets.EXPO_USERNAME }} || true
          fi
      # 9ï¸âƒ£ è°ƒè¯•ï¼šæ£€æŸ¥æ‰€æœ‰ä¾èµ–
      - name: Debug - Check all dependencies
        run: |
          echo "ğŸ“¦ æ£€æŸ¥ node_modules ä¸­çš„ expo ç›¸å…³åŒ…:"
          ls -la node_modules | grep expo || true
          echo ""
          echo "æ£€æŸ¥ expo-router:"
          ls -la node_modules/expo-router || echo "expo-router æœªæ‰¾åˆ°"
          echo ""
          echo "package.json ä¸­çš„ä¾èµ–:"
          cat package.json | jq '.dependencies' || cat package.json
      # ğŸ”Ÿ å°è¯•è¿è¡Œ expo configï¼ˆè°ƒè¯•ç”¨ï¼‰
      - name: Debug - Run expo config
        run: |
          echo "ğŸ” å°è¯•è¿è¡Œ expo config..."
          npx expo config --type public || {
            echo "âŒ expo config å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
            npx expo config || true
          }
      # 1ï¸âƒ£1ï¸âƒ£ é¢„æ„å»ºï¼ˆä½¿ç”¨æœ¬åœ°ç›¸åŒçš„å‘½ä»¤ï¼‰
      - name: Prebuild (like local)
        run: |
          echo "ğŸ“¦ é¢„æ„å»º..."
          # å¦‚æœä½ æœ¬åœ°ä½¿ç”¨è¿™ä¸ªå‘½ä»¤
          npx expo prebuild --platform android --clean
          
          # æˆ–è€…å¦‚æœä½ æœ¬åœ°ä¸éœ€è¦é¢„æ„å»ºï¼Œè·³è¿‡è¿™æ­¥
      # 1ï¸âƒ£2ï¸âƒ£ è·å–ç‰ˆæœ¬å·
      - name: Determine release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      # 1ï¸âƒ£3ï¸âƒ£ æ„å»º APKï¼ˆä½¿ç”¨ä¸æœ¬åœ°å®Œå…¨ç›¸åŒçš„å‘½ä»¤ï¼‰
      - name: Build APK (exact local command)
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æ„å»º..."
          echo "è¯·ç¡®ä¿ä»¥ä¸‹å‘½ä»¤ä¸ä½ æœ¬åœ°ä½¿ç”¨çš„å®Œå…¨ä¸€è‡´ï¼š"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p ./build
          
          # ä½¿ç”¨ä½ æœ¬åœ°çš„ç¡®åˆ‡å‘½ä»¤
          # é€‰é¡¹ 1: å¦‚æœä½ æœ¬åœ°ä½¿ç”¨ eas build
          eas build --platform android --profile preview --local --non-interactive --output ./build/couple-game.apk
          
          # é€‰é¡¹ 2: å¦‚æœä½ æœ¬åœ°ä½¿ç”¨ expo build
          # npx expo build:android -t apk
          
          # é€‰é¡¹ 3: å¦‚æœä½ æœ¬åœ°ä½¿ç”¨ gradle
          # cd android && ./gradlew assembleRelease
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EAS_BUILD_SKIP_CREDENTIALS_CHECK: 1
          EAS_NO_VCS_IGNORE_CHECK: 1

      # åç»­æ­¥éª¤ä¿æŒä¸å˜...
      - name: Find APK file
        id: find_apk
        run: |
          APK_FILE=$(find . -name "*.apk" -type f ! -path "./node_modules/*" | head -1)
          if [ -z "$APK_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶"
            find . -type f -name "*.apk"
            exit 1
          fi
          echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
          echo "apk_name=$(basename $APK_FILE)" >> $GITHUB_OUTPUT

      # ä¸Šä¼  APK ä¸º artifact
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 30

  build-ios:
    runs-on: macos-latest
    env:
      EXPO_NO_DOTENV: 1
      CI: false  # ç¦ç”¨ CI æ¨¡å¼ï¼Œæ¨¡æ‹Ÿæœ¬åœ°ç¯å¢ƒ
    steps:
      # 1ï¸âƒ£ è·å–ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # å¿…é¡»å®Œæ•´æ‹‰å– tag å†å²

      # 2ï¸âƒ£ è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3ï¸âƒ£ è®¾ç½® Xcode ç¯å¢ƒ
      - name: Setup Xcode
        run: |
          # ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆ Xcode
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      # 4ï¸âƒ£ æ˜¾ç¤º iOS ç¯å¢ƒä¿¡æ¯
      - name: Show iOS environment info
        run: |
          echo "ğŸ” iOS æ„å»ºç¯å¢ƒä¿¡æ¯ï¼š"
          echo "Node.js: $(node --version)"
          echo "NPM: $(npm --version)"
          echo "Xcode: $(xcodebuild -version)"
          echo "macOS: $(sw_vers -productVersion)"
          xcode-select --print-path

      # 5ï¸âƒ£ æ¸…ç†å¹¶å®‰è£…ä¾èµ–
      - name: Clean install
        run: |
          # å®Œå…¨æ¸…ç†
          rm -rf node_modules
          rm -rf .expo
          rm -rf ios/build
          rm -f yarn.lock
          rm -f package-lock.json

          # ä½¿ç”¨ yarn å®‰è£…
          npm install -g yarn
          yarn install

      # 6ï¸âƒ£ å®‰è£…å…¨å±€å·¥å…·
      - name: Install global tools
        run: |
          npm install -g eas-cli@latest
          npm install -g expo-cli@latest
          echo "å·²å®‰è£…çš„å…¨å±€åŒ…:"
          npm list -g --depth=0

      # 7ï¸âƒ£ è®¾ç½® Expo
      - name: Setup Expo
        run: |
          if [ -n "${{ secrets.EXPO_TOKEN }}" ]; then
            npx expo login --non-interactive -u ${{ secrets.EXPO_USERNAME }} || true
          fi

      # 8ï¸âƒ£ é¢„æ„å»º iOS
      - name: Prebuild iOS
        run: |
          echo "ğŸ“¦ iOS é¢„æ„å»º..."
          npx expo prebuild --platform ios --clean

      # 9ï¸âƒ£ å®‰è£… iOS ä¾èµ–
      - name: Install iOS dependencies
        run: |
          echo "ğŸ“¦ å®‰è£… CocoaPods ä¾èµ–..."
          cd ios
          # ç¡®ä¿ CocoaPods æ˜¯æœ€æ–°ç‰ˆæœ¬
          gem install cocoapods
          # å®‰è£…ä¾èµ–
          pod install
          cd ..

      # ğŸ”Ÿ è·å–ç‰ˆæœ¬å·
      - name: Determine release tag
        id: get_tag_ios
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      # 1ï¸âƒ£1ï¸âƒ£ æ„å»ºæœªç­¾å IPA (ä½¿ç”¨ xcodebuild)
      - name: Build unsigned IPA with xcodebuild
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºæœªç­¾å IPA..."

          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p ./build

          # è¿›å…¥ iOS ç›®å½•
          cd ios

          # æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
          echo "ğŸ“‹ é¡¹ç›®ä¿¡æ¯ï¼š"
          ls -la

          # æ‰¾åˆ° .xcworkspace æˆ– .xcodeproj æ–‡ä»¶
          WORKSPACE=$(find . -name "*.xcworkspace" | head -1)
          PROJECT=$(find . -name "*.xcodeproj" | grep -v Pods | head -1)

          if [ -n "$WORKSPACE" ]; then
            BUILD_TARGET="-workspace ${WORKSPACE}"
            echo "ä½¿ç”¨ workspace: $WORKSPACE"
            # åˆ—å‡ºå¯ç”¨çš„ schemes
            echo "å¯ç”¨çš„ schemes:"
            xcodebuild -list -workspace "$WORKSPACE" 2>/dev/null | grep -A 10 "Schemes:" || true
          elif [ -n "$PROJECT" ]; then
            BUILD_TARGET="-project ${PROJECT}"
            echo "ä½¿ç”¨ project: $PROJECT"F
            # åˆ—å‡ºå¯ç”¨çš„ schemes
            echo "å¯ç”¨çš„ schemes:"
            xcodebuild -list -project "$PROJECT" 2>/dev/null | grep -A 10 "Schemes:" || true
          else
            echo "âŒ æœªæ‰¾åˆ° .xcworkspace æˆ– .xcodeproj æ–‡ä»¶"
            exit 1
          fi

          # å°è¯•å‡ ä¸ªå¯èƒ½çš„ scheme åç§°
          POSSIBLE_SCHEMES=("couplegamern" "couple-game-rn" "CoupleGameRN" "main")
          SCHEME_NAME=""

          for scheme in "${POSSIBLE_SCHEMES[@]}"; do
            if xcodebuild -list $BUILD_TARGET 2>/dev/null | grep -q "$scheme"; then
              SCHEME_NAME="$scheme"
              echo "æ‰¾åˆ° scheme: $SCHEME_NAME"
              break
            fi
          done

          # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„ scheme
          if [ -z "$SCHEME_NAME" ]; then
            SCHEME_NAME=$(xcodebuild -list $BUILD_TARGET 2>/dev/null | grep -A 20 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
            echo "ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„ scheme: $SCHEME_NAME"
          fi

          if [ -z "$SCHEME_NAME" ]; then
            echo "âŒ æœªæ‰¾åˆ°å¯ç”¨çš„ scheme"
            exit 1
          fi

          # æ¸…ç†ä¹‹å‰çš„æ„å»º
          echo "ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»º..."
          xcodebuild clean $BUILD_TARGET -scheme "$SCHEME_NAME" -configuration Release

          # æ„å»ºé¡¹ç›®ï¼ˆä¸ç­¾åï¼‰
          echo "ğŸ”¨ å¼€å§‹æ„å»º..."
          xcodebuild archive \
            $BUILD_TARGET \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath "../build/$SCHEME_NAME.xcarchive" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM="" \
            | tee ../build/build.log

          # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
          if [ ! -d "../build/$SCHEME_NAME.xcarchive" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œarchive ä¸å­˜åœ¨"
            echo "æ„å»ºæ—¥å¿—ï¼š"
            cat ../build/build.log || true
            exit 1
          fi

          # å¯¼å‡º IPAï¼ˆæœªç­¾åï¼‰
          echo "ğŸ“¦ å¯¼å‡ºæœªç­¾å IPA..."

          # åˆ›å»ºå¯¼å‡ºé…ç½®æ–‡ä»¶
          cat > "../build/ExportOptions.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>development</string>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>stripSwiftSymbols</key>
              <false/>
          </dict>
          </plist>
          EOF

          # å¯¼å‡º IPA
          xcodebuild -exportArchive \
            -archivePath "../build/$SCHEME_NAME.xcarchive" \
            -exportPath "../build/" \
            -exportOptionsPlist "../build/ExportOptions.plist" \
            | tee ../build/export.log

          # é‡å‘½å IPA æ–‡ä»¶
          cd ../build
          if [ -f "$SCHEME_NAME.ipa" ]; then
            mv "$SCHEME_NAME.ipa" "couple-game-unsigned.ipa"
            echo "âœ… é‡å‘½å IPA: $SCHEME_NAME.ipa -> couple-game-unsigned.ipa"
          else
            # æŸ¥æ‰¾ä»»ä½• .ipa æ–‡ä»¶å¹¶é‡å‘½å
            IPA_FILE=$(find . -name "*.ipa" | head -1)
            if [ -n "$IPA_FILE" ]; then
              mv "$IPA_FILE" "couple-game-unsigned.ipa"
              echo "âœ… é‡å‘½å IPA: $(basename $IPA_FILE) -> couple-game-unsigned.ipa"
            else
              echo "âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„ IPA æ–‡ä»¶"
              echo "å¯¼å‡ºæ—¥å¿—ï¼š"
              cat export.log || true
              echo "æ„å»ºç›®å½•å†…å®¹ï¼š"
              ls -la
              exit 1
            fi
          fi

          echo "âœ… æ„å»ºå®Œæˆï¼"
          ls -la

      # 1ï¸âƒ£2ï¸âƒ£ æŸ¥æ‰¾ IPA æ–‡ä»¶
      - name: Find IPA file
        id: find_ipa
        run: |
          cd build
          IPA_FILE=$(find . -name "*.ipa" -type f | head -1)
          if [ -z "$IPA_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° IPA æ–‡ä»¶"
            echo "æ„å»ºç›®å½•å†…å®¹ï¼š"
            ls -la
            echo "æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶ï¼š"
            find . -type f
            exit 1
          fi

          # è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
          ABS_IPA_PATH=$(realpath "$IPA_FILE")

          echo "ipa_path=$ABS_IPA_PATH" >> $GITHUB_OUTPUT
          echo "ipa_name=$(basename $IPA_FILE)" >> $GITHUB_OUTPUT
          echo "âœ… æ‰¾åˆ° IPA æ–‡ä»¶: $ABS_IPA_PATH"

      # ä¸Šä¼  IPA ä¸º artifact
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ${{ steps.find_ipa.outputs.ipa_path }}
          retention-days: 30

  create-release:
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ è·å–ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./artifacts/

      - name: Download iOS IPA
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ./artifacts/

      # 3ï¸âƒ£ è·å–ç‰ˆæœ¬å·
      - name: Determine release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      # 4ï¸âƒ£ è·å–æäº¤æ—¥å¿—
      - name: Get Commit Logs
        id: get-logs
        run: |
            # è·å–æ‰€æœ‰ tagï¼ŒæŒ‰æ—¶é—´å€’åºæ’åˆ—
            TAGS=($(git tag --sort=-creatordate))

            if [ ${#TAGS[@]} -eq 0 ]; then
              echo "æ²¡æœ‰ä»»ä½• tag"
              PREVIOUS_TAG=""
              CURRENT_TAG=""
            elif [ ${#TAGS[@]} -eq 1 ]; then
              echo "åªæœ‰ä¸€ä¸ª tagï¼Œæ— æ³•ç”ŸæˆåŒºé—´æ—¥å¿—"
              PREVIOUS_TAG=""
              CURRENT_TAG=${TAGS[0]}
            else
              PREVIOUS_TAG=${TAGS[1]}
              CURRENT_TAG=${TAGS[0]}
            fi

            echo "Previous Tag: $PREVIOUS_TAG"
            echo "Current Tag: $CURRENT_TAG"

            if [ -n "$PREVIOUS_TAG" ]; then
              git log $PREVIOUS_TAG..$CURRENT_TAG --oneline > CHANGELOG.txt
            elif [ -n "$CURRENT_TAG" ]; then
              git log $CURRENT_TAG --oneline > CHANGELOG.txt
            else
              echo "æ²¡æœ‰å¯ç”¨æ—¥å¿—" > CHANGELOG.txt
            fi

            echo "changelog<<EOF" >> $GITHUB_ENV
            cat CHANGELOG.txt >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV

      # 5ï¸âƒ£ åˆ›å»º release å¹¶ä¸Šä¼ æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: Create GitHub Release and Upload Apps
        run: |
          echo "ğŸ“¦ åˆ›å»º release ${{ steps.get_tag.outputs.tag }}"

          # æŸ¥æ‰¾æ„å»ºäº§ç‰©
          APK_FILE=$(find ./artifacts -name "*.apk" | head -1)
          IPA_FILE=$(find ./artifacts -name "*.ipa" | head -1)

          APK_NAME=$(basename "$APK_FILE" 2>/dev/null || echo "couple-game.apk")
          IPA_NAME=$(basename "$IPA_FILE" 2>/dev/null || echo "couple-game-unsigned.ipa")

          # ç”Ÿæˆ release notes
          RELEASE_NOTES="ğŸ“± **å¿è½»æ¸¸ ${{ steps.get_tag.outputs.tag }}**

          ## ğŸ“± å®‰è£…è¯´æ˜
          ### Android
          ä¸‹è½½ \`$APK_NAME\` æ–‡ä»¶å¹¶å®‰è£…åˆ° Android è®¾å¤‡

          ### iOS (æœªç­¾å)
          ä¸‹è½½ \`$IPA_NAME\` æ–‡ä»¶ï¼Œéœ€è¦é€šè¿‡ AltStoreã€Sideloadly ç­‰å·¥å…·å®‰è£…åˆ° iOS è®¾å¤‡

          ## ğŸ”§ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - å¹³å°: Android + iOS (æœªç­¾å)
          - æ„å»ºæ–¹å¼: GitHub Actions è‡ªåŠ¨æ„å»º

          ## ğŸ“‹ æ›´æ–°å†…å®¹
          ${{ env.changelog }}

          ---
          ğŸ¤– æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»º"

          # åˆ›å»º release å¹¶ä¸Šä¼ æ–‡ä»¶
          UPLOAD_FILES=""
          [ -f "$APK_FILE" ] && UPLOAD_FILES="$UPLOAD_FILES $APK_FILE"
          [ -f "$IPA_FILE" ] && UPLOAD_FILES="$UPLOAD_FILES $IPA_FILE"

          gh release create "${{ steps.get_tag.outputs.tag }}" \
            $UPLOAD_FILES \
            --title "ğŸ® å¿è½»æ¸¸ ${{ steps.get_tag.outputs.tag }}" \
            --notes "$RELEASE_NOTES" \
            --draft=false \
            --prerelease=false

          echo "âœ… Release åˆ›å»ºæˆåŠŸï¼"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
