name: Build and Release

on:
  # æ–¹å¼ä¸€ï¼špush tag æ—¶è§¦å‘
  push:
    tags:
      - 'v*'
  # æ–¹å¼äºŒï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=2048m -Dorg.gradle.daemon=false
    steps:
      # 1ï¸âƒ£ è·å–ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      # 3ï¸âƒ£ ç¼“å­˜ Java ç¯å¢ƒ
      - name: Cache Java
        uses: actions/cache@v4
        id: cache-java
        with:
          path: |
            ~/.m2/repository
            /opt/hostedtoolcache/Java_Temurin-Hotspot
          key: java-17-temurin-${{ runner.os }}
          restore-keys: |
            java-17-temurin-
            java-17-

      # 3ï¸âƒ£.1 è®¾ç½® Java ç¯å¢ƒï¼ˆä»…åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶ï¼‰
      - name: Setup Java
        if: steps.cache-java.outputs.cache-hit != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 4ï¸âƒ£ ç¼“å­˜ Android SDK
      - name: Cache Android SDK
        uses: actions/cache@v4
        id: cache-android
        with:
          path: |
            ${{ env.ANDROID_HOME }}
            ~/.android
          key: android-sdk-34-${{ runner.os }}
          restore-keys: |
            android-sdk-34-
            android-sdk-

      # 4ï¸âƒ£.1 è®¾ç½® Android SDKï¼ˆä»…åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶ï¼‰
      - name: Setup Android SDK
        if: steps.cache-android.outputs.cache-hit != 'true'
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0

      # 4ï¸âƒ£.5 Accept Android licensesï¼ˆä»…åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶ï¼‰
      - name: Accept Android licenses
        if: steps.cache-android.outputs.cache-hit != 'true'
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      # 4ï¸âƒ£.6 è®¾ç½®ç¯å¢ƒå˜é‡
      - name: Setup environment variables
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV

      # 4ï¸âƒ£.7 ç¼“å­˜ Expo CLI
      - name: Cache Expo CLI
        uses: actions/cache@v4
        id: cache-expo
        with:
          path: |
            ~/.npm
            ~/.expo
          key: expo-${{ runner.os }}-${{ hashFiles('app.json', 'expo.json', 'app.config.*') }}
          restore-keys: |
            expo-${{ runner.os }}-

      # 4ï¸âƒ£.8 è®¾ç½® Expo CLI
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      # 4ï¸âƒ£.9 ç¼“å­˜ä¾èµ–å®‰è£…çŠ¶æ€
      - name: Cache dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            node_modules
            ~/.cache/yarn
          key: deps-${{ runner.os }}-${{ hashFiles('package.json', 'yarn.lock') }}
          restore-keys: |
            deps-${{ runner.os }}-

      # 5ï¸âƒ£ å®‰è£…å…¨å±€å·¥å…·
      - name: Install global tools
        run: |
          # æ£€æŸ¥ yarn æ˜¯å¦å·²å®‰è£…
          if ! command -v yarn &> /dev/null; then
            echo "Installing yarn..."
            npm install -g yarn
          else
            echo "Yarn already installed: $(yarn --version)"
          fi
          
          # å®‰è£… EAS CLI
          if ! command -v eas &> /dev/null; then
            echo "Installing eas-cli..."
            npm install -g eas-cli
          else
            echo "EAS CLI already installed: $(eas --version)"
          fi

      # 5ï¸âƒ£.1 å®‰è£…ä¾èµ–ï¼ˆä»…åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶ï¼‰
      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: yarn install --frozen-lockfile

      # 5ï¸âƒ£.5 æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
      - name: Show cache status
        run: |
          echo "ğŸ“‹ ç¼“å­˜çŠ¶æ€æŠ¥å‘Š:"
          echo "Java ç¼“å­˜å‘½ä¸­: ${{ steps.cache-java.outputs.cache-hit }}"
          echo "Android SDK ç¼“å­˜å‘½ä¸­: ${{ steps.cache-android.outputs.cache-hit }}"
          echo "ä¾èµ–ç¼“å­˜å‘½ä¸­: ${{ steps.cache-deps.outputs.cache-hit }}"
          echo "Expo ç¼“å­˜å‘½ä¸­: ${{ steps.cache-expo.outputs.cache-hit }}"
          echo ""
          echo "ğŸ”§ å·¥å…·ç‰ˆæœ¬:"
          echo "Node.js: $(node --version)"
          echo "NPM: $(npm --version)"
          echo "Yarn: $(yarn --version)"
          echo "EAS CLI: $(eas --version)"

      # 9ï¸âƒ£ è·å–ç‰ˆæœ¬å·
      - name: Determine release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      # ğŸ”Ÿ æœ¬åœ°æ„å»º APK
      - name: Build APK locally
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æœ¬åœ°æ„å»º APK..."
          npx eas build --platform android --profile preview --local --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # 1ï¸âƒ£1ï¸âƒ£ æŸ¥æ‰¾ç”Ÿæˆçš„ APK æ–‡ä»¶
      - name: Find APK file
        id: find_apk
        run: |
          APK_FILE=$(find . -name "*.apk" -type f | head -1)
          if [ -z "$APK_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶"
            exit 1
          fi
          echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
          echo "apk_name=$(basename $APK_FILE)" >> $GITHUB_OUTPUT
          echo "âœ… æ‰¾åˆ° APK æ–‡ä»¶: $APK_FILE"

      # 1ï¸âƒ£2ï¸âƒ£ åˆ›å»º release å¹¶ä¸Šä¼  APK
      - name: Create GitHub Release and Upload APK
        run: |
          echo "ğŸ“¦ åˆ›å»º release ${{ steps.get_tag.outputs.tag }}"
          
          # ç”Ÿæˆ release notes
          RELEASE_NOTES="ğŸš€ **å¿è½»æ¸¸ ${{ steps.get_tag.outputs.tag }}**

          ## ğŸ“± å®‰è£…è¯´æ˜
          ä¸‹è½½ \`${{ steps.find_apk.outputs.apk_name }}\` æ–‡ä»¶å¹¶å®‰è£…åˆ° Android è®¾å¤‡

          ## ğŸ”§ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Node.js: $(node --version)
          - å¹³å°: Android
          - æ„å»ºæ–¹å¼: æœ¬åœ°æ„å»º

          ## ğŸ“‹ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹æœ€è¿‘çš„æäº¤è®°å½•äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚

          ---
          ğŸ¤– æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»º"

          # åˆ›å»º release
          gh release create "${{ steps.get_tag.outputs.tag }}" \
            "${{ steps.find_apk.outputs.apk_path }}" \
            --title "ğŸ® å¿è½»æ¸¸ ${{ steps.get_tag.outputs.tag }}" \
            --notes "$RELEASE_NOTES" \
            --draft=false \
            --prerelease=false

          echo "âœ… Release åˆ›å»ºæˆåŠŸï¼"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
