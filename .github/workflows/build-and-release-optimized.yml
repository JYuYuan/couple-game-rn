name: Build and Release

on:
  # æ–¹å¼ä¸€ï¼špush tag æ—¶è§¦å‘
  push:
    tags:
      - '*'
  # æ–¹å¼äºŒï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.0.1)'
        required: true
        default: '0.0.1'

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    outputs:
      android_qrcode_url: ${{ steps.upload_android_pgyer.outputs.android_qrcode_url }}
      android_short_url: ${{ steps.upload_android_pgyer.outputs.android_short_url }}
      android_version: ${{ steps.upload_android_pgyer.outputs.android_version }}
    env:
      GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=2048m -Dorg.gradle.daemon=false
      EXPO_NO_DOTENV: 1
      CI: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0

      - name: Accept Android licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Setup environment variables
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "PATH=$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools" >> $GITHUB_ENV

      - name: Show environment info
        run: ./.github/scripts/show-env-info.sh

      - name: Install dependencies
        run: ./.github/scripts/install-deps.sh

      - name: Setup Expo
        run: |
          if [ -n "${{ secrets.EXPO_TOKEN }}" ]; then
            npx expo login --non-interactive -u ${{ secrets.EXPO_USERNAME }} || true
          fi

      - name: Build Android APK
        run: ./.github/scripts/build-android.sh
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EAS_BUILD_SKIP_CREDENTIALS_CHECK: 1
          EAS_NO_VCS_IGNORE_CHECK: 1

      - name: Find and upload APK
        run: |
          APK_FILE=$(find . -name "*.apk" -type f ! -path "./node_modules/*" | head -1)
          echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
          echo "apk_name=$(basename $APK_FILE)" >> $GITHUB_OUTPUT
        id: find_apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 30

      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Upload Android to Pgyer
        id: upload_android_pgyer
        run: ./.github/scripts/upload-to-pgyer.sh "${{ steps.find_apk.outputs.apk_path }}" "android"
        env:
          DANDELION_TOKEN: ${{ secrets.DANDELION_TOKEN }}

      - name: Display Android QR Code
        run: |
          echo "ğŸ“± Android Download Information:"
          echo "   Download URL: ${{ steps.upload_android_pgyer.outputs.android_short_url }}"
          echo "   QR Code: ${{ steps.upload_android_pgyer.outputs.android_qrcode_url }}"
          echo "   Version: ${{ steps.upload_android_pgyer.outputs.android_version }}"

  build-ios:
    runs-on: macos-latest
    outputs:
      ios_qrcode_url: ${{ steps.upload_ios_pgyer.outputs.ios_qrcode_url }}
      ios_short_url: ${{ steps.upload_ios_pgyer.outputs.ios_short_url }}
      ios_version: ${{ steps.upload_ios_pgyer.outputs.ios_version }}
    env:
      EXPO_NO_DOTENV: 1
      CI: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Show environment info
        run: ./.github/scripts/show-env-info.sh

      - name: Install dependencies
        run: ./.github/scripts/install-deps.sh

      - name: Setup Expo
        run: |
          if [ -n "${{ secrets.EXPO_TOKEN }}" ]; then
            npx expo login --non-interactive -u ${{ secrets.EXPO_USERNAME }} || true
          fi

      - name: Build iOS IPA
        run: ./.github/scripts/build-ios.sh

      - name: Find and upload IPA
        run: |
          IPA_FILE=$(find ./build -name "*.ipa" -type f | head -1)
          echo "ipa_path=$IPA_FILE" >> $GITHUB_OUTPUT
          echo "ipa_name=$(basename $IPA_FILE)" >> $GITHUB_OUTPUT
        id: find_ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ${{ steps.find_ipa.outputs.ipa_path }}
          retention-days: 30

      - name: Install jq for JSON parsing
        run: brew install jq || true

      - name: Upload iOS to Pgyer
        id: upload_ios_pgyer
        run: ./.github/scripts/upload-to-pgyer.sh "${{ steps.find_ipa.outputs.ipa_path }}" "ios"
        env:
          DANDELION_TOKEN: ${{ secrets.DANDELION_TOKEN }}

      - name: Display iOS QR Code
        run: |
          echo "ğŸ“± iOS Download Information:"
          echo "   Download URL: ${{ steps.upload_ios_pgyer.outputs.ios_short_url }}"
          echo "   QR Code: ${{ steps.upload_ios_pgyer.outputs.ios_qrcode_url }}"
          echo "   Version: ${{ steps.upload_ios_pgyer.outputs.ios_version }}"

  create-release:
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts/

      - name: Determine release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        run: |
          echo "ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯..."
          # å®‰å…¨åœ°è·å– tags
          TAGS=($(git tag --sort=-creatordate 2>/dev/null || echo ""))

          if [ ${#TAGS[@]} -eq 0 ]; then
            echo "æ²¡æœ‰æ‰¾åˆ°ä»»ä½• tagï¼Œä½¿ç”¨é¦–æ¬¡å‘å¸ƒ"
            echo "é¦–æ¬¡å‘å¸ƒ" > CHANGELOG.txt
          elif [ ${#TAGS[@]} -eq 1 ]; then
            echo "åªæœ‰ä¸€ä¸ª tag"
            echo "ç‰ˆæœ¬ ${TAGS[0]} å‘å¸ƒ" > CHANGELOG.txt
          else
            echo "æ‰¾åˆ°å¤šä¸ª tags"
            PREVIOUS_TAG=${TAGS[1]}
            CURRENT_TAG=${TAGS[0]}
            echo "ä» $PREVIOUS_TAG æ›´æ–°åˆ° $CURRENT_TAG"
            echo "ä»ç‰ˆæœ¬ $PREVIOUS_TAG æ›´æ–°åˆ° $CURRENT_TAG" > CHANGELOG.txt
          fi

          echo "ç”Ÿæˆçš„ç‰ˆæœ¬ä¿¡æ¯:"
          cat CHANGELOG.txt

      - name: Create GitHub Release
        run: ./.github/scripts/create-release.sh "${{ steps.get_tag.outputs.tag }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}